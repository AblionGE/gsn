<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<title>GSN</title>

<link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection"/>
<link rel="stylesheet" type="text/css" media="screen" href="style/ui.datepicker.css">

<!--
<script type="text/javascript" src="js/jquery-1.2.6/jquery-1.2.6.pack.js"></script>
<script type="text/javascript" src="js/jquery-1.2.6/ui/jquery-ui-core-1.5.2.min.js"></script>
<script type="text/javascript" src="js/jquery-1.2.6/ui/jquery-ui-accordion-1.5.2.min.js"></script>
<script type="text/javascript" src="js/jquery-1.2.6/ui/jquery-ui-tabs-1.5.2.min.js"></script>
<script type="text/javascript" src="js/jquery-1.2.6/ui/jquery-ui-datepicker-1.5.2.min.js"></script>  -->
<script type="text/javascript" src="js/dataclean.js"></script>

<script type="text/javascript" src="js/jquery.1.3.2.js"></script>

<!--<script language="javascript" type="text/javascript" src="js/jquery.js"></script>-->
<script language="javascript" type="text/javascript" src="js/jquery.flot.patched.js"></script>
<script language="javascript" type="text/javascript" src="js/jquery.flot.selection.js"></script>

<script type="text/javascript" src="js/simulation.js"></script>

<script type="text/javascript" src="js/datePicker.js"></script>
<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAMzANHtD0lZRRVCrPbKFfkRQgjQ95GGF6hnonCeqYiElIWyu18hSCTuhmhIfYuWivVq8y0t9zgqbuIQ"
                type="text/javascript"></script>

<script type="text/javascript">

    function initialize() {

      if (GBrowserIsCompatible()) {
        var map = new GMap2(document.getElementById("map_canvas"));
        map.setCenter(new GLatLng(Sim.station_lats[0],Sim.station_longs[0]), 12);

      function createMarker(point, index) {

          var marker = new GMarker(point);

          GEvent.addListener(marker, "click", function() {
            marker.openInfoWindowHtml(index);
            Sim.selectUnselect(index);
          });
          return marker;
        }


        // Add  markers to the map
        var bounds = map.getBounds();
        var southWest = bounds.getSouthWest();
        var northEast = bounds.getNorthEast();
        var lngSpan = northEast.lng() - southWest.lng();
        var latSpan = northEast.lat() - southWest.lat();
        for (var i = 0; i < 11; i++) {

          var latlng = new GLatLng(Sim.station_lats[i],Sim.station_longs[i]);
          var marker = createMarker(latlng, Sim.station_names[i]); //new GMarker(latlng);
          var name = "Station "+i;
          map.addOverlay(marker);

        }
          map.addControl(new GSmallMapControl());
          map.addControl(new GMapTypeControl());
      }
    }

</script>


<script id="getJSON" language="javascript" type="text/javascript">
    function getJSON() {


        //var fromDate = new Date(document.getElementById("date1").value);
        //var toDate = new Date(document.getElementById("date2").value);
        //alert(fromDate + "\n" +   " => " + toDate);

        var options = {
            series: { points: { show: false  }, lines: { show: true }, shadowSize: 0 },
            xaxis: { mode: "time", timeformat: "%y/%m/%d %h:%M:%s" },
            y2axis: {  min:0, max: 10, ticks: function(range) {
                return []
            } },
            selection: { mode: "xy" },

            colors: ["#22F722","#111111",  "#ff0000"]
        };

        var vs = document.getElementById("vs").value;
        var fiedname = document.getElementById("fieldname").value;
        var from = document.getElementById("from").value;
        var to = document.getElementById("to").value;
        var errorbound = document.getElementById("errorbound").value;
        var model = document.getElementById("model").value;
        var windowsize = document.getElementById("windowsize").value;

        //alert(from+" "+to+" "+vs+" "+fiedname+" "+errorbound);

        var getRequest = "dataclean?REQUEST=200&vs=" + vs + "&fieldname=" + fiedname + "&model=" + model + "&errorbound=" + errorbound + "&windowsize=" + windowsize + "&from=" + from + "&to=" + to;

        //console.log(getRequest);

        $.getJSON(getRequest,
                function(data) {
                    //console.log(data.data);
                    //alert(data.data);
                    DataClean.theData = data.data;
                    DataClean.plot = $.plot($("#placeholder"), data.data, options);
                    DataClean.previewPlot = $.plot($("#preview"), data.data,options);
                });

        $("#placeholder").bind("plotselected", function (event, ranges) {

        // do the zooming
        DataClean.plot = $.plot($("#placeholder"), DataClean.theData,
                      $.extend(true, {}, options, {
                          xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to },
                          yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to }
                      }));

        // don't fire event on the overview to prevent eternal loop
        DataClean.previewPlot.setSelection(ranges, true);
        });

        $("#preview").bind("plotselected", function (event, ranges) {
            DataClean.plot.setSelection(ranges);
        });




    }
    ;
</script>

<script id="getCleanedData" language="javascript" type="text/javascript">

    function getCleanedData() {

        var options = {
            series: { lines: { show: true }, points: { show: false }, shadowSize: 1 },
            grid: { hoverable: true, clickable: true },
            xaxis: { mode: "time", timeformat: "%y/%m/%d %h:%M" },
            y2axis: {  min:0, max: 10, ticks: function(range) {
                return []
            } },
            selection: { mode: "xy" } ,
            colors: ["#22F722", "#111111", "#ff0000"]
        };

        var vs = document.getElementById("vs").value;
        var fieldname = document.getElementById("fieldname").value;
        var from = document.getElementById("from").value;
        var to = document.getElementById("to").value;
        var errorbound = document.getElementById("errorbound").value;
        var model = document.getElementById("model").value;
        var windowsize = document.getElementById("windowsize").value;

        //var getRequest = "dataclean?REQUEST=200&vs=" + vs + "&fieldname=" + fiedname + "&model=" + model + "&errorbound=" + errorbound + "&windowsize=50&from=" + from + "&to=" + to;
        //$.get(getRequest);


        var getAllData = "dataclean?REQUEST=203&vs=" + vs + "&fieldname=" + fieldname + "&model=" + model + "&errorbound=" + errorbound + "&windowsize=" + windowsize + "&from=" + from + "&to=" + to;
        $.getJSON(getAllData,
                function(data) {
                    //console.log(data);

                    var pltStream = [];
                    var pltProcessed = [];
                    var pltDirtyness = [];

                    var j = 0;
                    var i;
                    for (i in data) {

                        // init chart
                        pltStream.push([data[j][1],data[j][2]]);
                        pltProcessed.push([data[j][1],data[j][3]]);
                        pltDirtyness.push([data[j][1],data[j][4]]);

                        // increment counter
                        j = j + 1;
                    }

                    DataClean.plot = $.plot($("#placeholder"),
                            [


                                {
                                    data:pltStream,
                                    label:fieldname ,
                                    points:{ show: false, radius:3 },
                                    lines: { show: true},
                                    highlightColor : "#FF0000"
                                },
                                {
                                    data:pltProcessed,
                                    lines: { show: true, fill:false, color:6 },
                                    label:"processed"
                                },
                                {
                                    data:pltDirtyness,
                                    bars:{show:true, fill:true},
                                    label:"dirtiness",
                                    yaxis:2
                                }
                            ],
                            options);

                });




        var getDirtyOnly = "dataclean?REQUEST=204&vs=" + vs + "&fieldname=" + fieldname + "&model=" + model + "&errorbound=" + errorbound + "&windowsize=" + windowsize + "&from=" + from + "&to=" + to;
        $.getJSON(getDirtyOnly,
                function(data) {
                    //console.log(data);

                    //alert(data.data);
                    var selectbox = document.getElementById("dirty_select");

                    // first, clean all
                    var k;
                    for (k = selectbox.options.length - 1; k >= 0; k--)
                    {
                        selectbox.remove(k);
                    }


                    var j = 0;
                    var i;
                    DataClean.orderOfDirtyPoint = new Array();
                    DataClean.errorOfDirtyPoint = new Array();

                    for (i in data) {

                        // init combo box
                        var optn = document.createElement("OPTION");
                        var d = data[j][3] - data[j][2];

                        DataClean.errorOfDirtyPoint[i] = d;
                        DataClean.orderOfDirtyPoint[i] = data[j][0]

                        optn.text = data[j][0] + " : " + data[j][2] + " (" + d.toPrecision(2) + ")";
                        optn.value = data[j][0];
                        selectbox.options.add(optn);

                        // increment counter
                        j = j + 1;
                    }
                });
        /*
        $("#placeholder").bind("plotclick", function (event, pos, item) {
            if (item) {
                alert("You clicked point " + item.dataIndex + " in " + item.series.label + ".");
                DataClea.plot.highlight(item.series, item.datapoint);
            }
        });     */
    }
    ;
</script>

<script id="doDeleteDirtyData" language="javascript" type="text/javascript">
    function deleteDirtyData() {

        var selectbox = document.getElementById("dirty_select");

        var todelete = "";
        for (var i = 0; i < selectbox.length; i++) {
            if (selectbox.options[i].selected) {
                todelete += selectbox.options[i].value;
                if (i < selectbox.length - 1) todelete += ",";
            }
        }
        alert("You have selected:" + todelete);

        var vs = document.getElementById("vs").value;
        var fiedname = document.getElementById("fieldname").value;
        var from = document.getElementById("from").value;
        var to = document.getElementById("to").value;
        var errorbound = document.getElementById("errorbound").value;
        var model = document.getElementById("model").value;
        var windowsize = document.getElementById("windowsize").value;

        var getCall = "dataclean?REQUEST=202&vs=" + vs + "&fieldname=" + fiedname + "&model=" + model + "&todelete=" + todelete;
        $.getJSON(getCall,
                function(data) {
                    alert(data);
                });
    }
    ;
</script>

<script id="highlightIt" language="javascript" type="text/javascript">
    function highlightIt() {
        var selectbox = document.getElementById("dirty_select");

        for (var i = 0; i < selectbox.length; i++) {
            if (selectbox.options[i].selected) {
                DataClean.plot.highlight(0,DataClean.orderOfDirtyPoint[i]);
            } else {
                DataClean.plot.unhighlight(0,DataClean.orderOfDirtyPoint[i]);
            }
        }
        //alert("You have selected:" + todelete);
        ;
    };

</script>

<script id="selectWithThreshold" language="javascript" type="text/javascript">
    function selectWithThreshold() {
        var selectbox = document.getElementById("dirty_select");
        var t = Number(document.getElementById("threshold").value);
        for (var i = 0; i < selectbox.length; i++) {
            //console.log(i+" : "+DataClean.orderOfDirtyPoint[i]+" ("+DataClean.errorOfDirtyPoint[i]+") ? "+t);
            if (DataClean.errorOfDirtyPoint[i]>=t | DataClean.errorOfDirtyPoint[i]<=-t) {
                DataClean.plot.highlight(0,DataClean.orderOfDirtyPoint[i]);

            } else {
                DataClean.plot.unhighlight(0,DataClean.orderOfDirtyPoint[i]);
            }
        }

        alert(t);
    };

</script>

<script id="createVS " language="javascript" type="text/javascript">
    function createVS () {

        var vs = document.getElementById("vs").value;
        var fieldname = document.getElementById("fieldname").value;
        var from = document.getElementById("from").value;
        var to = document.getElementById("to").value;
        var errorbound = document.getElementById("errorbound").value;
        var model = document.getElementById("model").value;
        var windowsize = document.getElementById("windowsize").value;

        var getCall = "dataclean?REQUEST=205&vs=" + vs + "&fieldname=" + fieldname + "&model=" + model + "&errorbound=" + errorbound + "&windowsize=" + windowsize + "&from=" + from + "&to=" + to;
        $.getJSON(getCall,
                function(data) {
                    alert(data);
                });
    }
    ;
</script>

<script type="text/javascript" charset="utf-8">


    $(function()
    {
        $('.date-pick').datePicker({startDate:'01/01/1996'});


    });
</script>


</head>
<body onload="initialize()" onunload="GUnload()">

<div id="container">
    <div id="header">
        <h1><a href="." id="gsn-name">GSN</a></h1>
    </div>
    <div id="navigation">
        <ul id="menu">
            <li class="selected"><a href="index.html#home">home</a></li>
            <li><a href="data.html#data">data</a></li>
            <li><a href="map.html#map">map</a></li>
            <li><a href="fullmap.html#fullmap">fullmap</a></li>
            <li class="selected"><a href="datacleaning.html#datacleaning">datacleaning</a></li>
        </ul>
        <ul id="linkWebsite">
            <li><a href="http://gsn.sourceforge.net/">GSN Home</a></li>
        </ul>
    </div>
    <div id="main2">
        <noscript><p class="error">Your browser doesn't appear to support JavaScript. This is most likely because you're
            using a text-based or otherwise non-graphical browser. Sadly, GSN require javascript in order to work
            properly. If you want to access directly the data, you can use the api at <a
                    href="http://localhost:22001/gsn">http://localhost:22001/gsn</a>.</p></noscript>

        <div id="control">

            <div id="msg">


                <h3 class="ui-accordion-header"><a href="#">Input stream</a></h3>

               <!-- <label for="date1">From</label>
                <input name="date1" id="date1" class="date-pick"/>
                <label for="date2">To</label>

                <input name="date2" id="date2" class="date-pick"/>-->

                <!--


                -->
                <div id="map_canvas" style="width: 600px; height: 400px"></div>

                <!--<p>Sensor <input id="vs" name="vs" size="16" type="text" value="lafouly_st_1043"/></p>-->
                <p>Sensor <select id="vs" name="vs">
					<option value="lafouly_st_1033">lafouly_st_1033</option>
					<option value="lafouly_st_1034">lafouly_st_1034</option>
					<option value="lafouly_st_1035">lafouly_st_1035</option>
					<option value="lafouly_st_1036">lafouly_st_1036</option>
					<option value="lafouly_st_1037">lafouly_st_1037</option>
					<option value="lafouly_st_1039">lafouly_st_1039</option>
					<option value="lafouly_st_1040">lafouly_st_1040</option>
                    <option value="lafouly_st_1041">lafouly_st_1041</option>
                    <option value="lafouly_st_1042"  selected="true">lafouly_st_1042</option>
                    <option value="lafouly_st_1043">lafouly_st_1043</option>
					<option value="lafouly_st_1044">lafouly_st_1044</option>
                </select></p>

				<!--
				hist_1033.xml  hist_1036.xml  hist_1040.xml  hist_1043.xm_
hist_1034.xml  hist_1037.xml  hist_1041.xml  hist_1044.xml
hist_1035.xml  hist_1039.xml  hist_1042.xm_

				-->

                <!--<p>Field <input id="fieldname" name="fieldname" size="16" type="text" value="air_temp"/></p>-->

                <p>Sensor <select id="fieldname" name="fieldname">
                    <option value="air_temp">air_temp</option>
                    <option value="air_humid">air_humid</option>
                    <option value="wind_speed">wind_speed</option>
                    <option value="rain_meter">rain_meter</option>
                    <option value="air_temp_tnx">air_temp_tnx</option>
                    <option value="ground_temp_tnx">ground_temp_tnx</option>
                </select></p>

                <p>From <input id="from" name="from" size="16" type="text" value="09/09/2009 09:00:00"/>

                    &nbsp;To <input id="to" name="to" size="16" type="text" value="11/09/2009 11:00:00"/></p>

                <h3 class="ui-accordion-header"><a href="#">Parameters</a></h3>

                <p>Model <select id="model" name="model">
                    <option value="0">Constant</option>
                    <option value="1">Linear</option>
                    <option value="2">Quadratic</option>
                    <option value="3">Chebyshev degree 1</option>
                    <option value="4">Chebyshev degree 2</option>
                    <option value="5">Chebyshev degree 3</option>
                </select></p>


                <p>
                    Error bound <input id="errorbound" name="errorbound" size="3" type="text" value="0.5"/>

                </p>

                <p>
                    Window size <input id="windowsize" name="windowsize" size="3" type="text" value="10"/>

                </p>


                <h3 class="ui-accordion-header"><a href="#">Output</a></h3>


                <label>
                    <input type="button" name="dorunservlet" id="dorunservlet" value="Apply model"
                           onclick="getJSON()"/>
                </label>

                <label>
                    <input type="button" name="dogetCleanedData" id="dogetCleanedData" value="Get dirty data"
                           onclick="getCleanedData()"/>
                </label>

                <label>
                    <input type="button" name="dogetCleanedData" id="deleteDirtyData" value="Delete dirty data"
                           onclick="deleteDirtyData()"/>
                </label>

                <label>
                    <input type="button" name="docreateVirtualSensor" id="createVirtualSensor" value="Create as VS"
                           onclick="createVS()"/>
                </label>

                <p><img id="imageholder" src=""/></p>

                <TABLE BORDER=0>
                    <TR>
                        <TD>
                            <div id="placeholder" style="width:600px;height:500px;background-color:#fff"></div>                        </TD>
                        <TD>
                            <p>
                            order:value (error)</p>
                            <p>
                            <select id="dirty_select" name="dirty_select" size="24" multiple="" style="display: block;" onclick="highlightIt()">

                              <option value="-1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</option>
                            </select>
                          </p>
                            <p>Thresh.
                              <label>
                              <input name="threshold" type="text" id="threshold" size="6" />
                              </label>
                              <label>
                              <input type="button" name="select" id="select" value="select (thres)" onclick="selectWithThreshold()"/>
                              </label>
                            </p>
                        <p>Use ctrl/shift to select multiple items</p></TD>
                  </TR>
                    <TR>
                        <td>
                            <div id="preview" style="width:150px;height:125px;background-color:#fff"></div>
                        </td>
                     <!--   <td><p><input id="enableTooltip" type="checkbox">Enable tooltip</p></td> -->
                    </TR>
                </TABLE>


          </div>

        </div>


    </div>


    <div id="footer">
        <p>Powered by <a href="http://globalsn.sourceforge.net/">GSN</a>, Distributed Information Systems Lab, EPFL 2006
        </p>

        <p>
            <a href="http://validator.w3.org/check?uri=referer"><img src="./img/html_valid.bmp"/></a>
            <a href="http://jigsaw.w3.org/css-validator/check?uri=referer"><img src="./img/css_valid.bmp"/></a>
        </p>
    </div>
</div>
</body>
</html>