<virtual-sensor name="Thur_Sampler6712_Algorithm__control__Id7000" priority="10" >
    <processing-class>
        <class-name>gsn.vsensor.Sampler6712ControlAlgorithmVS</class-name>
        <unique-timestamps>false</unique-timestamps>
        <init-params>
            <param name="threshold">10</param> <!-- threshold in uS/cm-->
            <param name="hold_time_in_min">10</param>  <!-- once signal the input has rised above the threshold, the hold time determines how long the output stays low -->
            <param name="window_size_in_min">720</param>  <!-- window size to use for the min/max value determination -->
            <param name="min_nb_of_data_points_within_hold_time">3</param>  <!-- min nb of data points within hold time, otherwise start condition check is skipped -->
            <param name="destination_device_id">7000</param> <!-- id of device to control (id of core station 6712 water sampler is connected to)-->
            
            <param name="core_station_wake_up_timeout_in_min">15</param> <!-- time before wake-up is sent again to CS-->
            <param name="core_station_wake_up_repetition_cnt">3</param> <!-- nb of attempts to wake up CS -->
            
            <!-- settings for static sampling -->
            <param name="sampling_start_delay_in_min">15</param>  <!-- delay between threshold condition fulfilled and first sampling, minimum value is 5min -->
            <param name="sampling_scheme">1,6,10,1000;7,12,30,1000;13,24,60,1000</param>

            <!-- settings for sending new schedule to core station (http post) -->
            <param name="schedule_host_name">http://whymper.ee.ethz.ch:23001/</param> <!-- host name of schedule VS location: PermaSense :: GSN - Test - Private -->
            <param name="schedule_vs_name">thur_schedule</param> <!-- VS name of schedule VS -->

            <!-- settings for wake up of core station (http post) -->
            <param name="dozer_command_host_name">http://whymper.ee.ethz.ch:22001/</param> <!-- host name of dozer command VS location: PermaSense :: GSN - Private -->
            <param name="dozer_command_vs_name">thur_dozer_command</param> <!-- VS name of dozer command VS -->
        </init-params>

        <web-input password="test">
         	<command name="configuration">
                <field name="control_state" type="select:leave_unchanged|on|off">on/off of control algorithm</field>
                <field name="special_action" type="select:none|reset_schedule_generation|manual_start_schedule_generation"></field>
        	</command>
   		</web-input>
        <output-structure>
            <field name="GENERATION_TIME" type="BIGINT" unit="unixtime" index="true"/> 
            <field name="TIMESTAMP" type="BIGINT" unit="unixtime"/>
            <field name="DEVICE_ID" type="INTEGER" /> <!-- device id of core station (6712 water sampler) under control -->
            <field name="DATA_TYPE" type="TINYINT" /> <!-- defines whether sensor (0) or control (1) data -->

            <field name="START_CONDITION_THRESHOLD" type="DOUBLE" />
            <field name="START_CONDITION_HOLD_TIME_IN_MIN" type="INTEGER" />
            <field name="WINDOW_SIZE_IN_MIN" type="INTEGER" />
            <field name="MINIMUM_NB_OF_DATA_POINTS_WITHIN_HOLD_TIME" type="INTEGER" />
            <field name="START_CONDITION_FULFILLED" type="TINYINT" />
            <field name="MIN" type="DOUBLE" />
            <field name="MAX" type="DOUBLE" />
            <field name="MIN_MAX_DELTA" type="DOUBLE" />
            
            <field name="CONTROL_ALGORITHM_ENABLE_STATE" type="TINYINT" />
            <field name="SCHEDULE_GENERATION_EVENT" type="VARCHAR(128)" />
            <field name="SCHEDULE_GENERATION_STATE" type="VARCHAR(128)" />
            
            <field name="AUTO_SCHEDULE_GENERATION_RESET_TIME_IN_MIN" type="INTEGER" />
       	</output-structure>
    </processing-class>
    <description>control algorithm for controlling 6712 water sampler at Thur deployment</description>
    <life-cycle pool-size="10" />
    <addressing />
    <storage />
    <streams>
        <!-- sensor data stream for control algorithm -->
        <stream name="sensor">
            <source alias="source" storage-size="1" sampling-rate="1">
                <address wrapper="local">
                    <predicate key="query">
                        select * from Thur_OutlierNoiseFilter_Pos4__Ch4
                    </predicate>
                </address>
                <query> select noise_filter_value as sensor_value, generation_time from wrapper
                </query>
            </source>
            <query> select * from source </query>
        </stream>

        <!-- schedule stream -->
        <stream name="schedule">
            <source alias="source" storage-size="1" sampling-rate="1">
                <address wrapper="local">
                    <predicate key="query"> select * from Thur_Schedule where device_id = 7000 </predicate>
                </address>
                <query> select * from wrapper 
                </query>
            </source>
            <query> select * from source </query>
        </stream>

        <!-- dozer command stream -->
        <stream name="dozer_command">
            <source alias="source" storage-size="1" sampling-rate="1">
                <address wrapper="remote-rest">
                    <predicate key="query"> select * from Thur_Dozer_Command where device_id = 7000 </predicate>
                    <predicate key="remote-contact-point">http://whymper.ee.ethz.ch:22001/streaming/</predicate> <!-- PermaSense :: GSN - Private -->
                </address>
                <query> select * from wrapper 
                </query>
            </source>
            <query> select * from source </query>
        </stream>

    </streams>
</virtual-sensor>


