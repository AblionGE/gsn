<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<title>GSN</title>
	
	<link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" />
	<script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
	<script type="text/javascript" src="js/jquery-dom.js"></script>
	<script type="text/javascript" src="js/jquery.history.js"></script>
	<script type="text/javascript" src="js/jquery-tooltip.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	
	<!-- the mousewheel plugin - optional to provide mousewheel support -->
	<script type="text/javascript" src="js/jquery.mousewheel.js"></script>

	<!-- the jScrollPane script -->
	<script type="text/javascript" src="js/jquery.jscrollpane.min.js"></script>
	
	<style type="text/css" id="page-css">
		/* Styles specific to this particular page */
		.scroll-pane
		{
			width: 100%;
			height: 600px;
			overflow: auto;
		}
	</style>

    <script type="text/javascript" src="js/uptime.js"></script>

<script type="text/javascript">
<!--//<![CDATA[

var LOOK_N_DAYS_BACK = 5;
var MAX_LOGS_PER_REQUEST = 50;
var MAX_LOGS_TOTAL = 1000;
var UPDATE_INTERVAL = 2;

var deployments = new Array();
var selectedDeploymentNr;
var scrollPane;

var fieldIdentifier = "device_id";
var tableEnding = "";

function deployment(name) {
	this.name = name;
	this.coreStations = new Array();
	this.lastLogTime = "";
	this.dozerEventsExists = false;
	this.dozerEventsSelected = false;
	this.dozerEventsInitialized = false;
	this.dozerEventsfirstTimestamp;
	this.lastEventTime = "";
}

function coreStation(fieldId) {
	this.fieldId = fieldId;
	this.selected = false;
	this.firstTimestamp;
	this.initialized = false;
}

function getAvailableCoreStations(deploymentId) {
	var date = new Date((new Date()).getTime()-(LOOK_N_DAYS_BACK*86400000));
	var ids = new Array();
	$.ajax({
		type: "GET",
		url: "/data?vsName=" + deployments[deploymentId].name.toLowerCase() + "_syslogng" + tableEnding + "&fields=" + fieldIdentifier + "&orderby=timestamp&groupby=" + fieldIdentifier + "&critfield=timestamp&neg=&critop=%3E&critval=" + date.getTime(),
        async: false,
        cache: false,
        timeout: 30000,
		success: function(data){
			$("line", data).each(function(){
				var l = $("field", this).text();
				if (l != fieldIdentifier && l.toLowerCase() != "null")
					ids.push(new coreStation(l))
			});
		}
	});
	return ids;
}

function fieldIdExists(depl, id) {
	var exists = false;
	$.each(depl.coreStations, function() {
		if (id == this.fieldId) {
			exists = true;
			return false;
		}
	});
	return exists;
}

function getLastLogs(deploymentId, corestation) {
	$.ajax({
		type: "GET",
		url: "/data?vsName=" + deployments[deploymentId].name.toLowerCase() + "_syslogng" + tableEnding + "&fields=timestamp&fields=log_message&orderby=timestamp&critfield=" + fieldIdentifier + "&neg=&critop==&critval=" + corestation.fieldId + "&nb=" + MAX_LOGS_PER_REQUEST,
        async: false,
        cache: false,
        timeout: 30000,
		success: function(data){
			var lastLogTime = "";
			$($("line", data).get().reverse()).each(function(i){
				if ($("field:eq(0)", this).text() != "timestamp") {
					if (i == 0)
						corestation.firstTimestamp = $("field:eq(0)", this).text();
					lastLogTime = $("field:eq(0)", this).text();
					$('.jspPane',"#corestation_" + deployments[deploymentId].name + "_" + corestation.fieldId).append(generateSyslogNgMessageDiv(lastLogTime, $("field:eq(1)", this).text()));
				}
			});
			deployments[deploymentId].lastLogTime = lastLogTime;
		}
	});
}

function getLastEvents(deployment) {
	$.ajax({
		type: "GET",
		url: "/data?vsName=" + deployment.name.toLowerCase() + "_dozer_eventlogger__mapped&fields=event_timestamp&fields=device_id&fields=event_id&fields=event_type&fields=event_value&orderby=event_timestamp&nb=" + MAX_LOGS_PER_REQUEST,
        async: false,
        cache: false,
        timeout: 30000,
		success: function(data){
			var lastEventTime = "";
			$($("line", data).get().reverse()).each(function(i){
				if ($("field:eq(0)", this).text() != "event_timestamp") {
					if (i == 0)
						deployment.dozerEventsfirstTimestamp = $("field:eq(0)", this).text();
					lastEventTime = $("field:eq(0)", this).text();
					$('.jspPane',"#dozer_events_" + deployment.name).append(generateEventMessageDiv(lastEventTime, $("field:eq(1)", this).text(), $("field:eq(2)", this).text(), $("field:eq(3)", this).text(), $("field:eq(4)", this).text()));
				}
			});
			deployment.lastEventTime = lastEventTime;
		}
	});
}

function getMaxLogsRecursive(deplName, fieldId, lastTimestamp) {
	var tmp = "";
	if (lastTimestamp != "")
		tmp = "&critJoin=and&critfield=timestamp&neg=&critop=<&critval=" + lastTimestamp;
	$.ajax({
		type: "GET",
		url: "/data?vsName=" + deplName.toLowerCase() + "_syslogng" + tableEnding + "&fields=timestamp&fields=log_message&orderby=timestamp&critfield=" + fieldIdentifier + "&neg=&critop==&critval=" + fieldId + "&nb=" + MAX_LOGS_PER_REQUEST + tmp,
		async: false,
		cache: false,
		timeout: 30000,
		success: function(data){
			var lastLogTime = "";
			$("line", data).each(function(){
				if ($("field:eq(0)", this).text() != "timestamp") {
					lastLogTime = $("field:eq(0)", this).text();
					$('.jspPane',"#corestation_" + deplName + "_" + fieldId).prepend(generateSyslogNgMessageDiv(lastLogTime, $("field:eq(1)", this).text()));
				}
			});
			scrollPane.reinitialise();
			if (lastLogTime != "" && $('.jspPane',"#corestation_" + deplName + "_" + fieldId).find("div").length < MAX_LOGS_TOTAL)
				getMaxLogsRecursive(deplName, fieldId, lastLogTime);
		}
	});
}

function getMaxEventsRecursive(deplName, lastTimestamp) {
	var tmp = "";
	if (lastTimestamp != "")
		tmp = "&critJoin=and&critfield=event_timestamp&neg=&critop=<&critval=" + lastTimestamp;
	$.ajax({
		type: "GET",
		url: "/data?vsName=" + deplName.toLowerCase() + "_dozer_eventlogger__mapped&fields=event_timestamp&fields=device_id&fields=event_id&fields=event_type&fields=event_value&orderby=event_timestamp&nb=" + MAX_LOGS_PER_REQUEST + tmp,
		async: false,
		cache: false,
		timeout: 30000,
		success: function(data){
			var lastEventTime = "";
			$("line", data).each(function(){
				if ($("field:eq(0)", this).text() != "event_timestamp") {
					lastEventTime = $("field:eq(0)", this).text();
					$('.jspPane',"#dozer_events_" + deplName).prepend(generateEventMessageDiv(lastEventTime, $("field:eq(1)", this).text(), $("field:eq(2)", this).text(), $("field:eq(3)", this).text(), $("field:eq(4)", this).text()));
				}
			});
			scrollPane.reinitialise();
			if (lastEventTime != "" && $('.jspPane',"#dozer_events_" + deplName).find("div").length < MAX_LOGS_TOTAL)
				getMaxEventsRecursive(deplName, lastEventTime);
		}
	});
}

function getLogs() {
	var seldepl = selectedDeploymentNr;
	var isEvents = deployments[seldepl].dozerEventsExists && deployments[seldepl].dozerEventsSelected;
	var crit = "&nb=1";
	var firstFieldIdentifier = "timestamp";
	if (deployments[seldepl].lastLogTime != "")
		crit = "&critfield=" + firstFieldIdentifier + "&neg=&critop=>&critval=" + deployments[seldepl].lastLogTime + "&nb=" + MAX_LOGS_TOTAL;	
	var query = deployments[seldepl].name.toLowerCase() + "_syslogng" + tableEnding + "&fields=" + firstFieldIdentifier + "&fields=" + fieldIdentifier + "&fields=log_message&orderby=" + firstFieldIdentifier + crit;
	
	if (isEvents) {
		firstFieldIdentifier = "event_timestamp";
		if (deployments[seldepl].lastEventTime != "")
			crit = "&critfield=" + firstFieldIdentifier + "&neg=&critop=>&critval=" + deployments[seldepl].lastEventTime + "&nb=" + MAX_LOGS_TOTAL;
		
		query = deployments[seldepl].name.toLowerCase() + "_dozer_eventlogger__mapped&fields=" + firstFieldIdentifier + "&fields=device_id&fields=event_id&fields=event_type&fields=event_value&orderby=" + firstFieldIdentifier + crit;
	}
	
	$.ajax({
		type: "GET",
		url: "/data?vsName=" + query,
		success: function(data){
			var lastTime = "";
			$($("line", data).get().reverse()).each(function(){
				var l = $("field:eq(1)", this).text();
				if ($("field:eq(0)", this).text() != firstFieldIdentifier && l.toLowerCase() != "null") {
					var container;
					if (isEvents) {
						container = $('.jspPane',"#dozer_events_" + deployments[seldepl].name);
						lastTime = $("field:eq(0)", this).text();
						container.append(generateEventMessageDiv(lastTime, $("field:eq(1)", this).text(), $("field:eq(2)", this).text(), $("field:eq(3)", this).text(), $("field:eq(4)", this).text()));
					}
					else {
						if (!fieldIdExists(deployments[seldepl], $("field:eq(1)", this).text()))
							addNewCoreStation(deployments[seldepl], l, true);
						
						container = $('.jspPane',"#corestation_" + deployments[seldepl].name + "_" + parseInt(l));
						lastTime = $("field:eq(0)", this).text();
						container.append(generateSyslogNgMessageDiv(lastTime, $("field:eq(2)", this).text()));
					}
					
					$($(container).children().get().reverse()).each(
						function(i, elemLi) {
							if(i >= MAX_LOGS_TOTAL)
								$(this).remove();
						}
					);
				}
			});
			if (lastTime != "") {
				scrollPane.reinitialise();
				if (isEvents)
					deployments[seldepl].lastEventTime = lastTime;
				else
					deployments[seldepl].lastLogTime = lastTime;
			}
			setTimeout("getLogs()",UPDATE_INTERVAL*1000);
		}
	});
}

function generateSyslogNgMessageDiv(timestamp, msg) {
	var color = "";
	var spl = msg.split(" ", 5);
	var message = msg.substring(msg.indexOf(spl[4])+spl[4].length+1, msg.length);
	if (parseInt(spl[0].slice(1,spl[0].length-1))%8<=3)
		color = ";color:red";
	return "<div style=\"width: 10000px" + color + "\">" + (new Date(parseFloat(timestamp))).toString() + ": " + message + "</div>";
}

function generateEventMessageDiv(timestamp, deviceId, eventId, eventType, eventValue) {
	return "<div style=\"width: 10000px\">" + (new Date(parseFloat(timestamp))).toString() + ": device id=" + deviceId + ", event id=" + eventId + ", event type=" + eventType + ", event value=" + eventValue + "</div>";
}

function addNewCoreStation(depl, id, show) {
	var cs = new coreStation(id);
	$("#corestation_menu_"+depl.name).append($.LI({}, $.A({
	"id":"corestation_menu_item_"+depl.name+"_"+id,
	"href":"javascript:showCoreStation("+id+")"
	},id)));
	// add div
	$("#logscontainer").append("<div class=\"scroll-pane\" id=\"corestation_"+depl.name+"_"+id+"\"></div>");
	if (show) {
		$("#corestation_menu_"+depl.name).show();
		$("#corestation_"+depl.name+"_"+id).show();
	}
	else {
		$("#corestation_menu_"+depl.name).hide();
		$("#corestation_"+depl.name+"_"+id).hide();
	}
	scrollPane = $(".scroll-pane").jScrollPane({showArrows:true,stickToBottom:true,horizontalGutter:10}).data('jsp');
	if (depl.coreStations.length < 1) {
		$("#corestation_menu_item_"+depl.name+"_"+id).addClass("selected");
		cs.selected = true;
	}
	depl.coreStations.push(cs)
}

$(document).ready(function() {
	$("#starttext").html('<p>Loading syslog-ng data... <img src="style/ajax-loader.gif" /></p>');
	
	$("#corestation_navigation").hide();
	$.get('/menu.jsp', {selected: "logs"}, function(data) {
		$('#navigation').html(data);
	}, 'html');
	$("#navigation ul a.local").bind("click",function() { return GSN.nav($(this).text()); });
	
	// deployments
	// load deployments
	$.ajax({
		type: "GET",
		url: "/gsn?structure",
		success: function(data){
			if ($(document).attr("title")=="GSN") {
			    var gsn = $("gsn",data);
			    $(document).attr("title",$(gsn).attr("name"));
			    $("#gsn-name").empty().append($(gsn).attr("name"));
			    $("#gsn-desc").empty().append($(gsn).attr("description"));
			    $("#gsn-author").empty().append($(gsn).attr("author")+" ("+$(gsn).attr("email")+")");
			    var gsnname = $(gsn).attr("name").replace(/.*::\s*GSN\s*-\s*/, "").replace(/\s/g,"").toLowerCase();
			    $('head', document).append('<link rel="shortcut icon" href="/img/favicon/permasense-'+gsnname+'.ico"><link rel="icon" href="/img/favicon/permasense-'+gsnname+'.ico">');
			}
			$("#gsn-name").show();
			uptime.setTime($(gsn).attr("uptime"));
			var arraySize = 0;
			// iterate over all available virtual sensors
			$("virtual-sensor",data).each(function(){
				// are there syslog-ng or eventlogger__mapped vs available?
				if ($(this).attr("name").indexOf("syslogng") != -1 || $(this).attr("name").indexOf("_dozer_eventlogger__mapped") != -1) {
					// private or public?
					if ($(this).attr("name").indexOf("__mapped") != -1) {
						tableEnding = "__mapped";
						fieldIdentifier = "position";
					}
				    var deploymentname = $(this).attr("name").split("_", 1)[0];
				    if(deploymentname.length > 1) {
						deploymentname = deploymentname.substring(0, 1).toUpperCase() + deploymentname.substring(1, deploymentname.length).toLowerCase();
						if (deploymentname!='Statistics') {
							var depl;
							$.each(deployments, function(){
								if (this.name == deploymentname) {
									depl = this;
									return false;
								}
							});
							if (depl === undefined) {
								depl = new deployment(deploymentname);
						    	deployments.push(depl);
							}

							// does the deployment offer dozer event logger information?
							if ($(this).attr("name").indexOf("_dozer_eventlogger__mapped") != -1)
								depl.dozerEventsExists = true;
						}
				    }
				}
			});
			// display
			var visible = 0;
			$.each(deployments, function(i, l){
				if (this.name == $.cookie("deployment")) {
					visible = i;
					return false;
				}
			});
			
			$.each(deployments, function(i, depl) {
			    // add tab
			    $("#deployment_menu").append($.LI({}, $.A({
				"id":"deployment_menu_item_"+depl.name,
				"href":"javascript:showDeployment("+i+")"
			    },depl.name)));
			    
			    $("#corestation_menu").append($.LI({
			    "id":"corestation_menu_"+depl.name
			    }));
			    
			    if (depl.dozerEventsExists) {
				    $("#corestation_menu_"+depl.name).append('<li style="padding:0 8px">DozerEvents:</li>');
					$("#corestation_menu_"+depl.name).append($.LI({}, $.A({
					"id":"dozer_events_menu_item_"+depl.name,
					"href":"javascript:showDozerEvents("+i+")"
					},"X")));
					$("#corestation_menu_"+depl.name).append('<li style="width:50px">&nbsp;</li>');
					// add div
					$("#logscontainer").append("<div class=\"scroll-pane\" id=\"dozer_events_"+depl.name+"\"></div>");
					$("#dozer_events_"+depl.name).hide();

					scrollPane = $(".scroll-pane").jScrollPane({showArrows:true,stickToBottom:true,horizontalGutter:10}).data('jsp');
			    }
			    
			    $("#corestation_menu_"+depl.name).append('<li style="padding:0 8px">' + fieldIdentifier + ':</li>');
			    
				$.each(getAvailableCoreStations(i), function(){
					addNewCoreStation(depl, this.fieldId, false);
				});
				
				$.each(depl.coreStations, function(){
				    getLastLogs(i, this);
				});
				
			    if (depl.dozerEventsExists)
					getLastEvents(depl);
				$("#deployment_"+depl.name).hide();
			});
			$("#corestation_navigation").show();
			showDeployment(visible);
		  	getLogs();
		}
	});
});

function showDeployment(id) {
	var selCoreStation;
	$.each(deployments, function() {
		var depl = this;
		$("#corestation_menu_"+depl.name).hide();
		$("#deployment_"+depl.name).hide();
		$("#deployment_menu_item_"+depl.name).removeClass("selected");
		$.each(depl.coreStations, function() {
			if ((depl.name == deployments[id].name) && this.selected) {
				scrollPane = $("#corestation_"+depl.name+"_"+this.fieldId).show().jScrollPane({showArrows:true,stickToBottom:true,horizontalGutter:10}).data('jsp');
				selCoreStation = this;
			}
			else
				$("#corestation_"+depl.name+"_"+this.fieldId).hide();
		});
		if (depl.dozerEventsExists)
			$("#dozer_events_"+depl.name).hide();
	});

	if (selCoreStation === undefined)
		scrollPane = $("#dozer_events_"+deployments[id].name).show().jScrollPane({showArrows:true,stickToBottom:true,horizontalGutter:10}).data('jsp');
	
	$("#deployment_"+deployments[id].name).show();
	$("#deployment_menu_item_"+deployments[id].name).addClass("selected");
	$.cookie("deployment" , deployments[id].name);
	selectedDeploymentNr = id;
	if (deployments[id].coreStations.length > 0) {
		$("#corestation_menu_"+deployments[id].name).show();
		scrollPane.reinitialise();
		scrollPane.scrollToBottom();
		if (selCoreStation === undefined && !deployments[id].dozerEventsInitialized) {
			$("#starttext").html('<p>Loading dozer event log data... <img src="style/ajax-loader.gif" /></p>');
			deployments[id].dozerEventsInitialized = true;
			getMaxEventsRecursive(deployments[id].name, deployments[id].dozerEventsfirstTimestamp);
			$("#starttext").html("<p>Logging data.</p>");
		}
		else if (!(selCoreStation === undefined) && !selCoreStation.initialized) {
			$("#starttext").html('<p>Loading syslog-ng data... <img src="style/ajax-loader.gif" /></p>');
			selCoreStation.initialized = true;
			getMaxLogsRecursive(deployments[id].name, selCoreStation.fieldId, selCoreStation.firstTimestamp);
			$("#starttext").html("<p>Logging data.</p>");
		}
	}
}

function showCoreStation(fieldId) {
	var selCoreStation;
	if (deployments[selectedDeploymentNr].dozerEventsExists) {
		deployments[selectedDeploymentNr].dozerEventsSelected = false;
		$("#dozer_events_"+deployments[selectedDeploymentNr].name).hide();
		$("#dozer_events_menu_item_"+deployments[selectedDeploymentNr].name).removeClass("selected");
	}
	$.each(deployments[selectedDeploymentNr].coreStations, function() {
		$("#corestation_"+deployments[selectedDeploymentNr].name+"_"+this.fieldId).hide();
		$("#corestation_menu_item_"+deployments[selectedDeploymentNr].name+"_"+this.fieldId).removeClass("selected");
		if (this.fieldId == fieldId) {
			selCoreStation = this;
			this.selected = true;
		}
		else
			this.selected = false;
	});
	scrollPane = $("#corestation_"+deployments[selectedDeploymentNr].name+"_"+fieldId).show().jScrollPane({showArrows:true,stickToBottom:true,horizontalGutter:10}).data('jsp');
	$("#corestation_menu_item_"+deployments[selectedDeploymentNr].name+"_"+fieldId).addClass("selected");
	scrollPane.reinitialise();
	scrollPane.scrollToBottom();
	
	if (!selCoreStation.initialized) {
		$("#starttext").html('<p>Loading syslog-ng data... <img src="style/ajax-loader.gif" /></p>');
		selCoreStation.initialized = true;
		getMaxLogsRecursive(deployments[selectedDeploymentNr].name, fieldId, selCoreStation.firstTimestamp);
		$("#starttext").html("<p>Logging data.</p>");
	}
}

function showDozerEvents(id) {
	deployments[id].dozerEventsSelected = true;
	$.each(deployments[id].coreStations, function() {
		$("#corestation_"+deployments[id].name+"_"+this.fieldId).hide();
		$("#corestation_menu_item_"+deployments[id].name+"_"+this.fieldId).removeClass("selected");
		this.selected = false;
	});
	scrollPane = $("#dozer_events_"+deployments[id].name).show().jScrollPane({showArrows:true,stickToBottom:true,horizontalGutter:10}).data('jsp');
	$("#dozer_events_menu_item_"+deployments[id].name).addClass("selected");
	scrollPane.reinitialise();
	scrollPane.scrollToBottom();

	if (!deployments[id].dozerEventsInitialized) {
		$("#starttext").html('<p>Loading dozer event log data... <img src="style/ajax-loader.gif" /></p>');
		deployments[id].dozerEventsInitialized = true;
		getMaxEventsRecursive(deployments[id].name, deployments[id].dozerEventsfirstTimestamp);
		$("#starttext").html("<p>Logging data.</p>");
	}
}
//]]>-->
</script>
</head>
<body>

<div id="container">
	<div id="header">
		<h1><a href="." id="gsn-name" style="display:none">GSN</a></h1>
	</div>
	<div id="navigation">
	</div>
	
	<div id="separator">
		<div id="starttext" />
	</div>
	
	
	<div id="maindiv">

		<div id="deployment_navigation">
		<ul id="deployment_menu">
		<li />
		</ul>
		</div>
		
		<div id="corestation_navigation">
		<ul id="corestation_menu">
		<li />
		</ul>
		</div>
		
		<div id="logscontainer" style="text-align:left;margin:5px"></div>
		
	</div>
	<div class="separator">
		<div id="footer">
		      <table width="100%">
				<tr>
					<td style="width:50%;color:#444444;"><b>A Project of <a href="http://www.ethz.ch" target="_blank">ETH Zurich</a>, <a href="http://www.unibas.ch" target="_blank">Uni Basel</a> and <a href="http://www.uzh.ch" target="_blank">Uni Zurich</a></b></td>
					<td style="text-align:right;width:50%;font-size:9px;">Powered by <a href="http://gsn.sourceforge.net/">GSN</a>,  Distributed Information Systems Lab, EPFL 2006</td>
				</tr>
			</table>
		</div>
	</div>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5632004-2");
pageTracker._initData();
pageTracker._trackPageview();
</script>
</body>
</html>
