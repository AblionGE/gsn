<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
	<title>GSN</title>
	
	<link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" />
	<script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
	<script type="text/javascript" src="js/jquery-dom.js"></script>
	<script type="text/javascript" src="js/jquery.history.js"></script>
	<script type="text/javascript" src="js/jquery-tooltip.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	
	<!-- the mousewheel plugin - optional to provide mousewheel support -->
	<script type="text/javascript" src="js/jquery.mousewheel.js"></script>

	<!-- the jScrollPane script -->
	<script type="text/javascript" src="js/jquery.jscrollpane.min.js"></script>
	
	<style type="text/css" id="page-css">
		/* Styles specific to this particular page */
		.scroll-pane
		{
			width: 100%;
			height: 600px;
			overflow: auto;
		}
	</style>

    <script type="text/javascript" src="js/uptime.js"></script>

<script type="text/javascript">
<!--//<![CDATA[

var LOOK_N_DAYS_BACK = 5;
var MAX_LOGS_PER_REQUEST = 50;
var MAX_LOGS_TOTAL = 1000;
var UPDATE_INTERVAL = 2;

var EVENT_MSG = new Array(
	 "","",
	 "" /* not used EVENT_COMMAND_RECEIVED %s*/,
	 "" /* not used EVENT_EVENT_Q_FULL %s */,
	 "Node resetted, resetcounter is %s." /* EVENT_RESET %s*/,
	 "" /* not used EVENT_WATCHDOG_RESET %s */,
	 "","","","",
	 "Dozer: Connected to parent %s." /* EVENT_CHILD_CONNECT %s */,
	 "" /* not used EVENT_CHILD_DISCONNECT %s */,
	 "" /* not used EVENT_CHILD_DISCONNECT_ROUTING_LOOP %s */,
	 "Dozer: No beacon received, failed connection attempts: %s." /* EVENT_CHILD_NO_BEACON %s */,
	 "Dozer: Could not upload data in this round, failed connection attempts: %s." /* EVENT_CHILD_NO_DATAUPLOAD %s */,
	 "" /* not used EVENT_CHILD_RESET_OVERHEARTIME %s */,
	 "Dozer: Found %s potential parents." /* EVENT_CHILD_FOUND_PARENTS %s */,
	 "","","",
	 "Dozer: Got connection from child %s." /* EVENT_PARENT_CONNECT %s */,
	 "Dozer: Disconnected child %s." /* EVENT_PARENT_DISCONNECT %s */,
	 "" /* not used EVENT_DOZER_WATCHDOG %s */,
	 "","","","","","","",
	 "" /* not used EVENT_BB_POWER_ON %s */,
	 "Baseboard power off, shutdownrequest was %s." /* EVENT_BB_POWER_OFF %s */,
	 "Received power switch command with value %s." /*EVENT_PSB_POWER %s */,
	 "Baseboard: Set new schedule interval to %s seconds." /* EVENT_BB_NEWSCHEDULE %s */,
	 "Baseboard: Set new servicewindow to %s seconds." /* EVENT_BB_NEWSERVICEWINDOW %s */,
	 "" /* not used EVENT_BB_NEWSERVICEWINDOW_INVALID %s*/ ,
	 "Baseboard: Set V12DC_EXT to %s." /* EVENT_BB_V12DC_EXT_SW %s */,
	 "","","",
	 "Received datasource config command %s." /*EVENT_DATACONFIG %s*/,
	 "Wxt520 init failed with code %s." /*EVENT_WXT520_INIT_FAIL %s*/,
	 "","","","","","","","",
	 "" /* not used EVENT_ERROR_SD_MOUNT %s */,
	 "" /* not used EVENT_ERROR_SD_GENERIC %s*/,
	 "","","","","","","","",
	 "" /* not used EVENT_ERROR_RADIO_GENERIC %s */,
	 "SX1211: Radio pattern error %s." /* EVENT_ERROR_RADIO_PATTERN %s",
	 "","","","","","","","",
	 "" /* not used EVENT_AE_ARM_POWER_ON %s */,
	 "" /* not used EVENT_AE_ARM_POWER_OFF %s */,
	 "" /* not used EVENT_AE_ARM_RESET %s */,
	 "" /* not used EVENT_AE_ARM_COMM_TIMEOUT %s */,
	 "AE board: set new posttrigger to %s." /* EVENT_AE_POSTTRIGGER_SET %s */,
	 "AE board: set new threshhold to %s." /* EVENT_AE_THRESHOLD_SET %s */ );
		 
var EVENT_MSG_NULL = new Array(
	 "","",
	 "" /* not used EVENT_COMMAND_RECEIVED */,
	 "Event queue is full, there could be dropped events." /* EVENT_EVENT_Q_FULL */,
	 "" /* not used EVENT_RESET */,
	 "Node started after watchdog reset." /* EVENT_WATCHDOG_RESET */,
	 "","","","",
	 "" /* not used EVENT_CHILD_CONNECT */,
	 "Dozer: Disconnected from parent." /* EVENT_CHILD_DISCONNECT */,
	 "Dozer: Disconnected due to routing loop." /* EVENT_CHILD_DISCONNECT_ROUTING_LOOP */,
	 "" /* not used EVENT_CHILD_NO_BEACON */,
	 "" /* not used EVENT_CHILD_NO_DATAUPLOAD */,
	 "Dozer: Reset overhear time." /* EVENT_CHILD_RESET_OVERHEARTIME */,
	 "" /* not used EVENT_CHILD_FOUND_PARENTS */,
	 "","","",
	 "" /* not used EVENT_PARENT_CONNECT */,
	 "" /* not used EVENT_PARENT_DISCONNECT */,
	 "Dozer: Watchdog triggered." /* EVENT_DOZER_WATCHDOG */,
	 "","","","","","","",
	 "Baseboard power on." /* EVENT_BB_POWER_ON */,
	 "" /* not used EVENT_BB_POWER_OFF */,
	 "" /* not used EVENT_PSB_POWER */,
	 "Baseboard: Received invalid schedule interval." /* EVENT_BB_NEWSCHEDULE */,
	 "Baseboard: Disabled servicewindow." /* EVENT_BB_NEWSERVICEWINDOW*/,
	 "Baseboard: Received invalid servciewindow interval." /* EVENT_BB_NEWSERVICEWINDOW_INVALID */,
	 "" /* not used EVENT_BB_V12DC_EXT_SW */,
	 "","","",
	 "" /* not used EVENT_DATACONFIG */,
	 "" /* not used EVENT_WXT520_INIT_FAIL */,
	 "","","","","","","","",
	 "Error while mounting SD card." /* EVENT_ERROR_SD_MOUNT */,
	 "Generic SD card error." /* EVENT_ERROR_SD_GENERIC */,
	 "","","","","","","","",
	 "" /* not used EVENT_ERROR_RADIO_GENERIC*/,
	 "" /* not used EVENT_ERROR_RADIO_PATTERN*/,
	 "","","","","","","","",
	 "AE board: ARM power on." /* EVENT_AE_ARM_POWER_ON */,
	 "AE board: ARM power off." /* EVENT_AE_ARM_POWER_OFF */,
	 "AE board: ARM reset." /* EVENT_AE_ARM_RESET */,
	 "AE board: Communication to ARM timed out." /* EVENT_AE_ARM_COMM_TIMEOUT */,
	 "" /* not used EVENT_AE_POSTTRIGGER_SET */,
	 "" /* not used EVENT_AE_THRESHOLD_SET */);
		
var EVENT_MSG_ERRORLEVELS = new Array(
	 6,6,
	 6 /* EVENT_COMMAND_RECEIVED */,
	 4 /* EVENT_EVENT_Q_FULL */,
	 4 /* EVENT_RESET */,
	 3 /* EVENT_WATCHDOG_RESET */,
	 6,6,6,6,
	 6 /* EVENT_CHILD_CONNECT */,
	 6 /* EVENT_CHILD_DISCONNECT */,
	 6 /* EVENT_CHILD_DISCONNECT_ROUTING_LOOP */,
	 6 /* EVENT_CHILD_NO_BEACON */,
	 6 /* EVENT_CHILD_NO_DATAUPLOAD */,
	 6 /* EVENT_CHILD_RESET_OVERHEARTIME */,
	 6 /* EVENT_CHILD_FOUND_PARENTS */,
	 6,6,6,
	 6 /* EVENT_PARENT_CONNECT */,
	 6 /* EVENT_PARENT_DISCONNECT */,
	 3 /* EVENT_DOZER_WATCHDOG */,
	 6,6,6,6,6,6,6,
	 6 /* EVENT_BB_POWER_ON */,
	 6 /* EVENT_BB_POWER_OFF */,
	 6 /* EVENT_PSB_POWER */,
	 6 /* EVENT_BB_NEWSCHEDULE */,
	 6 /* EVENT_BB_NEWSERVICEWINDOW*/,
	 4 /* EVENT_BB_NEWSERVICEWINDOW_INVALID */,
	 6 /* EVENT_BB_V12DC_EXT_SW */,
	 6,6,6,
	 6 /* EVENT_DATACONFIG */,
	 3 /* EVENT_WXT520_INIT_FAIL */,
	 6,6,6,6,6,6,6,6,
	 3 /* EVENT_ERROR_SD_MOUNT */,
	 3 /* EVENT_ERROR_SD_GENERIC */,
	 6,6,6,6,6,6,6,6,
	 3 /* EVENT_ERROR_RADIO_GENERIC*/,
	 3 /* EVENT_ERROR_RADIO_PATTERN*/,
	 6,6,6,6,6,6,6,6,
	 6 /* EVENT_AE_ARM_POWER_ON */,
	 6 /* EVENT_AE_ARM_POWER_OFF */,
	 6 /* EVENT_AE_ARM_RESET */,
	 6 /* EVENT_AE_ARM_COMM_TIMEOUT */,
	 6 /* EVENT_AE_POSTTRIGGER_SET */,
	 6 /* EVENT_AE_THRESHOLD_SET */);

var deployments = new Array();
var logContainers = new Array()
var selectedDeploymentId;
var selectedLogContainerId;
var scrollPane;
var isPublicGSN = false;

function deployment(name) {
	this.name = name;
	this.identifiers = new Array();
	this.lastLogTime = "";
	this.lastEventTime = "";
	this.topologyExists = false;
	this.dozerEventsExists = false;
}

function logContainer(name, deplId, containerId, identifier) {
	this.name = name;
	this.deplId = deplId;
	this.containerId = containerId;
	this.identifier = identifier;
	this.firstTimestamp;
	this.initialized = false;
}

function getTableEnding() {
	if (isPublicGSN)
		return "__mapped";
	else
		return "";
}

function getFieldIdentifier() {
	if (isPublicGSN)
		return "position";
	else
		return "device_id";
}

function getAvailableCoreStations(depl) {
	var deviceIds = new Array();
	if (depl.topologyExists) {
		var tableEnding = "";
		if (isPublicGSN)
			tableEnding = "__public";
		$.ajax({
			type: "GET",
	        url: "/field?vs="+depl.name.toLowerCase() + "_topology" + tableEnding + "&field=DATA&pk=latest",
	        dataType: "xml",
	        async: false,
	        cache: false,
	        timeout: 30000,
			success: function(data){
				$("sensornode[iscorestation=true]",data).each(function(){
					if (isPublicGSN)
						deviceIds.push($(this).attr("position"));
					else
						deviceIds.push($(this).attr("node_id"));
				});
			}
		});
	}
	else {
		var date = new Date((new Date()).getTime()-(LOOK_N_DAYS_BACK*86400000));
		$.ajax({
			type: "GET",
			url: "/data?vsName=" + depl.name.toLowerCase() + "_syslogng" + getTableEnding() + "&fields=" + getFieldIdentifier() + "&orderby=timestamp&groupby=" + getFieldIdentifier() + "&critfield=timestamp&neg=&critop=%3E&critval=" + date.getTime(),
	        async: false,
	        cache: false,
	        timeout: 30000,
			success: function(data){
				$("line", data).each(function(){
					var l = $("field", this).text();
					if (l != getFieldIdentifier() && l.toLowerCase() != "null")
						deviceIds.push(l)
				});
			}
		});
	}
	return deviceIds.sort(function(a,b){return a - b});
}

function identifierExists(depl, id) {
	var exists = false;
	$.each(depl.identifiers, function() {
		if (id == this) {
			exists = true;
			return false;
		}
	});
	return exists;
}

function getLastLogs(logContainer) {
	var deployment = deployments[logContainer.deplId];
	if (logContainer.identifier === "dozerevents") {
		$.ajax({
			type: "GET",
			url: "/data?vsName=" + deployment.name.toLowerCase() + "_dozer_eventlogger__mapped&fields=event_timestamp&fields=position&fields=device_id&fields=event_id&fields=event_value&orderby=event_timestamp&nb=" + MAX_LOGS_PER_REQUEST,
	        async: false,
	        cache: false,
	        timeout: 30000,
			success: function(data){
				var lastEventTime = "";
				$($("line", data).get().reverse()).each(function(i){
					if ($("field:eq(0)", this).text() != "event_timestamp") {
						if (i == 0)
							logContainer.firstTimestamp = $("field:eq(0)", this).text();
						lastEventTime = $("field:eq(0)", this).text();
						$('.jspPane',"#logcontainer_" + logContainer.containerId).append(generateEventMessageDiv(lastEventTime, $("field:eq(1)", this).text(), $("field:eq(2)", this).text(), $("field:eq(3)", this).text(), $("field:eq(4)", this).text()));
					}
				});
				deployment.lastEventTime = lastEventTime;
			}
		});
	}
	else {
		$.ajax({
			type: "GET",
			url: "/data?vsName=" + deployment.name.toLowerCase() + "_syslogng" + getTableEnding() + "&fields=timestamp&fields=log_message&fieldslinked=false&orderby=timestamp&critfield=" + getFieldIdentifier() + "&neg=&critop==&critval=" + logContainer.identifier + "&nb=" + MAX_LOGS_PER_REQUEST,
	        async: false,
	        cache: false,
	        timeout: 30000,
			success: function(data){
				var lastLogTime = "";
				$($("line", data).get().reverse()).each(function(i){
					if ($("field:eq(0)", this).text() != "timestamp") {
						if (i == 0)
							logContainer.firstTimestamp = $("field:eq(0)", this).text();
						lastLogTime = $("field:eq(0)", this).text();
						$('.jspPane',"#logcontainer_" + logContainer.containerId).append(generateSyslogNgMessageDiv(lastLogTime, $("field:eq(1)", this).text()));
					}
				});
				deployment.lastLogTime = lastLogTime;
			}
		});
	}
}

function getMaxLogsRecursive(logContainer, lastTimestamp) {
	var deplName = deployments[logContainer.deplId].name;
	if (logContainer.identifier === "dozerevents") {
		var tmp = "";
		if (lastTimestamp != "")
			tmp = "&critJoin=and&critfield=event_timestamp&neg=&critop=<&critval=" + lastTimestamp;
		$.ajax({
			type: "GET",
			url: "/data?vsName=" + deplName.toLowerCase() + "_dozer_eventlogger__mapped&fields=event_timestamp&fields=position&fields=device_id&fields=event_id&fields=event_value&orderby=event_timestamp&nb=" + MAX_LOGS_PER_REQUEST + tmp,
			async: false,
			cache: false,
			timeout: 30000,
			success: function(data){
				var lastEventTime = "";
				$("line", data).each(function(){
					if ($("field:eq(0)", this).text() != "event_timestamp") {
						lastEventTime = $("field:eq(0)", this).text();
						$('.jspPane',"#logcontainer_" + logContainer.containerId).prepend(generateEventMessageDiv(lastEventTime, $("field:eq(1)", this).text(), $("field:eq(2)", this).text(), $("field:eq(3)", this).text(), $("field:eq(4)", this).text()));
					}
				});
				scrollPane.reinitialise();
				if (lastEventTime != "" && $('.jspPane',"#logcontainer_" + logContainer.containerId).find("div").length < MAX_LOGS_TOTAL)
					getMaxLogsRecursive(logContainer, lastEventTime);
			}
		});
	}
	else {
		var tmp = "";
		if (lastTimestamp != "")
			tmp = "&critJoin=and&critfield=timestamp&neg=&critop=<&critval=" + lastTimestamp;
		$.ajax({
			type: "GET",
			url: "/data?vsName=" + deplName.toLowerCase() + "_syslogng" + getTableEnding() + "&fields=timestamp&fields=log_message&fieldslinked=false&orderby=timestamp&critfield=" + getFieldIdentifier() + "&neg=&critop==&critval=" + logContainer.identifier + "&nb=" + MAX_LOGS_PER_REQUEST + tmp,
			async: false,
			cache: false,
			timeout: 30000,
			success: function(data){
				var lastLogTime = "";
				$("line", data).each(function(){
					if ($("field:eq(0)", this).text() != "timestamp") {
						lastLogTime = $("field:eq(0)", this).text();
						$('.jspPane',"#logcontainer_" + logContainer.containerId).prepend(generateSyslogNgMessageDiv(lastLogTime, $("field:eq(1)", this).text()));
					}
				});
				scrollPane.reinitialise();
				if (lastLogTime != "" && $('.jspPane',"#logcontainer_" + logContainer.containerId).find("div").length < MAX_LOGS_TOTAL)
					getMaxLogsRecursive(logContainer, lastLogTime);
			}
		});
	}
}

function getLogs() {
	var sdid = selectedDeploymentId;
	var isEvents = logContainers[selectedLogContainerId].identifier === "dozerevents";
	var crit = "&nb=1";
	var firstFieldIdentifier = "timestamp";
	if (deployments[sdid].lastLogTime != "")
		crit = "&critfield=" + firstFieldIdentifier + "&neg=&critop=>&critval=" + deployments[sdid].lastLogTime + "&nb=" + MAX_LOGS_TOTAL;	
	var query = deployments[sdid].name.toLowerCase() + "_syslogng" + getTableEnding() + "&fields=" + firstFieldIdentifier + "&fields=" + getFieldIdentifier() + "&fields=log_message&fieldslinked=false&orderby=" + firstFieldIdentifier + crit;
	
	if (isEvents) {
		firstFieldIdentifier = "event_timestamp";
		if (deployments[sdid].lastEventTime != "")
			crit = "&critfield=" + firstFieldIdentifier + "&neg=&critop=>&critval=" + deployments[sdid].lastEventTime + "&nb=" + MAX_LOGS_TOTAL;
		
		query = deployments[sdid].name.toLowerCase() + "_dozer_eventlogger__mapped&fields=" + firstFieldIdentifier + "&fields=position&fields=device_id&fields=event_id&fields=event_value&orderby=" + firstFieldIdentifier + crit;
	}
	
	$.ajax({
		type: "GET",
		url: "/data?vsName=" + query,
		success: function(data){
			var lastTime = "";
			$($("line", data).get().reverse()).each(function(){
				var l = $("field:eq(1)", this).text();
				if ($("field:eq(0)", this).text() != firstFieldIdentifier && l.toLowerCase() != "null") {
					var container;
					if (isEvents) {
						container = $('.jspPane',"#logcontainer_" + selectedLogContainerId);
						lastTime = $("field:eq(0)", this).text();
						container.append(generateEventMessageDiv(lastTime, $("field:eq(1)", this).text(), $("field:eq(2)", this).text(), $("field:eq(3)", this).text(), $("field:eq(4)", this).text()));
					}
					else {
						var id;
						var str = $("field:eq(1)", this).text();
						if (!identifierExists(deployments[sdid], str)) {
							if (isPublicGSN)
								addNewLogContainer(sdid, str, "CoreStation Pos " + str);
							else
								addNewLogContainer(sdid, str, "CoreStation Id " + str);
							id = this.containerId;
						}
						else {
							$.each(logContainers, function() {
								if (this.deplId == sdid && this.identifier == l) {
									id = this.containerId;
									return false;
								}
							});
						}
						container = $('.jspPane',"#logcontainer_" + id);
						lastTime = $("field:eq(0)", this).text();
						container.append(generateSyslogNgMessageDiv(lastTime, $("field:eq(2)", this).text()));
					}
					
					$($(container).children().get().reverse()).each(
						function(i, elemLi) {
							if(i >= MAX_LOGS_TOTAL)
								$(this).remove();
						}
					);
				}
			});
			if (lastTime != "") {
				scrollPane.reinitialise();
				if (isEvents)
					deployments[sdid].lastEventTime = lastTime;
				else
					deployments[sdid].lastLogTime = lastTime;
			}
			setTimeout("getLogs()",UPDATE_INTERVAL*1000);
		}
	});
}

function generateSyslogNgMessageDiv(timestamp, msg) {
	var spl = msg.split(" ", 5);
	var logMsg = (new Date(parseFloat(timestamp))).toLocaleString() + ": " + msg.substring(msg.indexOf(spl[4])+spl[4].length+1, msg.length);
	
	var color = "";
	var priority = parseInt(spl[0].slice(1,spl[0].length-1))%8;
	if (priority == 4)
		color = "; color: chocolate";
	else if (priority <= 3)
		color = "; color: red";
	
	var display = "; display: none";
	if (logMsg.indexOf(getSearchString()) != -1)
		display = "; display: block";
	
	return "<div style=\"width: 10000px" + display + color + "\">" + logMsg + "</div>";
}

function generateEventMessageDiv(timestamp, position, deviceId, eventId, eventValue) {
	var id = parseInt(eventId);
	var logMsg = (new Date(parseFloat(timestamp))).toLocaleString() + ": Position " + position + " (DeviceId " + deviceId + "): ";
	if (eventValue.toLowerCase() == "null")
		logMsg += EVENT_MSG_NULL[id];
	else
		logMsg += EVENT_MSG[id].replace('%s', eventValue);
	
	var color = "";
	if (EVENT_MSG_ERRORLEVELS[id] == 4)
		color = "; color: chocolate";
	else if (EVENT_MSG_ERRORLEVELS[id] <= 3)
		color = "; color: red";
	
	var display = "; display: none";
	if (logMsg.indexOf(getSearchString()) != -1)
		display = "; display: block";
	
	return "<div style=\"width: 10000px" + display + color + "\">" + logMsg + "</div>";
}

function addNewLogContainer(deplId, identifier, menuString) {
	$("#log_menu_"+deplId).append('<li style="border-right:0px solid #000000"><a id="log_menu_item_' + logContainers.length + '" href="javascript:showLogs('+deplId+','+logContainers.length+')">' + menuString + '</a></li>');
	$("#logcontainers").append("<div class=\"scroll-pane\" id=\"logcontainer_"+logContainers.length+"\"></div>");
	scrollPane = $(".scroll-pane").jScrollPane({showArrows:true,stickToBottom:true,horizontalGutter:10}).data('jsp');
	logContainers.push(new logContainer(menuString, deplId, logContainers.length, identifier));
}

function filterLogs(searchString) {
    // make only matched names visible
    $(".jspPane").children().each(function() {
		if ($(this).text().indexOf(searchString) != -1)
			$(this).show();
		else
			$(this).hide();
    });
	scrollPane.scrollTo(0,0);
	scrollPane.reinitialise();
	scrollPane.scrollToBottom();
}

function getSearchString() {
	var tmp = $("#logsearch").val();
	if (tmp == "search logs")
		return "";
	else
		return tmp;
}

$(document).ready(function() {
	$("#starttext").html('Loading log messages... <img src="style/ajax-loader.gif" />');
	$("#logcontainers").hide();
	
	$.get('/menu.jsp', {selected: "logs"}, function(data) {
		$('#navigation').html(data);
	}, 'html');
	$("#navigation ul a.local").bind("click",function() { return GSN.nav($(this).text()); });

    //bind log search field
	$("#logsearch").css("color", "#bbbbbb");
    $("#logsearch").val("search logs");
    $("#logsearch").focus(function() {
		$("#logsearch").css("color", "#000000");
    	if ($("#logsearch").val() == "search logs")
    		$("#logsearch").val("");
    	else
      		this.select();
    });
    $("#logsearch").keyup(function(event) {
		if ($("#logsearch").val() != "" && $("#logsearch").val() != "search logs") {
			$("#logsearch").css("color", "#000000");
			$("#logsearch_clear").attr("src", "img/button_cancel.png");
	    	if (13 != (event.keyCode || event.which))
				$("#logsearch_go").attr("src", "img/button_go.png");
		}
		else {
			$("#logsearch_clear").attr("src", "img/button_cancel_grey.png");
	    	if (13 == (event.keyCode || event.which))
				$("#logsearch").css("color", "#bbbbbb");
		}
    });
    $("#logsearch").keypress(function(event) {
		$("#logsearch").css("color", "#000000");
    	if (13 == (event.keyCode || event.which)) {
        	filterLogs(getSearchString());
    		$("#logsearch_go").attr("src", "img/button_go_grey.png");
    		if ($("#logsearch").val() == "") {
    	      	$("#logsearch").val("search logs");
    		}
    	}
    });
    $("#logsearch").blur(function(event) {
		if ($("#logsearch").val() == "") {
			$("#logsearch").css("color", "#bbbbbb");
	      	$("#logsearch").val("search logs");
		}
    });
    
    $("#logsearch_clear").click(function() {
		$("#logsearch").css("color", "#bbbbbb");
      	$("#logsearch").val("search logs");
		$("#logsearch_clear").attr("src", "img/button_cancel_grey.png");
		$("#logsearch_go").attr("src", "img/button_go_grey.png");
      	filterLogs(getSearchString());
    });
    $("#logsearch_go").click(function() {
		$("#logsearch_go").attr("src", "img/button_go_grey.png");
      	filterLogs(getSearchString());
    });
	
	// deployments
	// load deployments
	$.ajax({
		type: "GET",
		url: "/gsn?structure",
		success: function(data){
			if ($(document).attr("title")=="GSN") {
			    var gsn = $("gsn",data);
			    $(document).attr("title",$(gsn).attr("name"));
			    $("#gsn-name").empty().append($(gsn).attr("name"));
			    $("#gsn-desc").empty().append($(gsn).attr("description"));
			    $("#gsn-author").empty().append($(gsn).attr("author")+" ("+$(gsn).attr("email")+")");
			    var gsnname = $(gsn).attr("name").replace(/.*::\s*GSN\s*-\s*/, "").replace(/\s/g,"").toLowerCase();
			    $('head', document).append('<link rel="shortcut icon" href="/img/favicon/permasense-'+gsnname+'.ico"><link rel="icon" href="/img/favicon/permasense-'+gsnname+'.ico">');
			}
			$("#gsn-name").show();
			uptime.setTime($(gsn).attr("uptime"));
			// iterate over all available virtual sensors
			$("virtual-sensor",data).each(function(){
				// are there syslog-ng or eventlogger__mapped vs available?
				if ($(this).attr("name").indexOf("syslogng") != -1 || $(this).attr("name").indexOf("topology") != -1 || $(this).attr("name").indexOf("_dozer_eventlogger__mapped") != -1) {
					// private or public?
					if ($(this).attr("name").indexOf("__mapped") != -1)
						isPublicGSN = true;
					
				    var deploymentname = $(this).attr("name").split("_", 1)[0];
				    if(deploymentname.length > 1) {
						deploymentname = deploymentname.substring(0, 1).toUpperCase() + deploymentname.substring(1, deploymentname.length).toLowerCase();
						if (deploymentname!='Statistics') {
							var depl;
							$.each(deployments, function(){
								if (this.name == deploymentname) {
									depl = this;
									return false;
								}
							});
							if (depl === undefined) {
								depl = new deployment(deploymentname);
						    	deployments.push(depl);
							}

							// does the deployment offer dozer event logger information?
							if ($(this).attr("name").indexOf("_dozer_eventlogger__mapped") != -1)
								depl.dozerEventsExists = true;

							// does the deployment offer topology information?
							if ($(this).attr("name").indexOf("topology") != -1)
								depl.topologyExists = true;
						}
				    }
				}
			});
			// display
			var visible = 0;
			$.each(deployments, function(i, depl) {
				if (this.name == $.cookie("deployment"))
					visible = i;
				
			    // add tab
			    $("#deployment_menu").append($.LI({
				"id":"deployment_menu_item_"+i},
				$.A({
				"href":"javascript:showLogs("+i+",-1)"
			    },depl.name)));
			    
			    $("#deployment_menu_item_"+i).append('<ul id="log_menu_' + i + '" class="subnav" style="z-index: 1" />');
				
				$("#deployment_menu_item_"+i).hover(function() {
					$("#log_menu_"+i).slideDown('fast').show();
					
					$(this).find("ul.subnav").hover(function() {
					}, function(){
						$(this).slideUp('slow');
					});
				}, function() {
					$(this).find("ul.subnav").slideUp('slow');
				});
			    
				$.each(getAvailableCoreStations(depl), function(){
					if (isPublicGSN)
						addNewLogContainer(i, this, "CoreStation Pos " + this);
					else
						addNewLogContainer(i, this, "CoreStation Id " + this);
					depl.identifiers.push(this);
				});
			    
			    if (depl.dozerEventsExists)
			    	addNewLogContainer(i, "dozerevents", "Dozer Event");
			});
			
			$.each(logContainers, function(){
			    getLastLogs(this);
				$("#logcontainer_"+this.containerId).hide();
			});

			$("#logcontainers").show();
			showLogs(visible, -1);
		  	getLogs();
		}
	});
});

function showLogs(deplId, logId) {
	if (deplId != selectedDeploymentId) {
		$("#deployment_menu_item_"+selectedDeploymentId).removeClass("selected");

		$("#deployment_menu_item_"+deplId).addClass("selected");
		$.cookie("deployment" , deployments[deplId].name);
		selectedDeploymentId = deplId;
		
		if (logId == -1) {
			$.each(logContainers, function() {
				if (this.deplId == selectedDeploymentId) {
					logId = this.containerId;
					return false;
				}
			});
		}
	}
	
	if (logId != -1) {
		if (logId != selectedLogContainerId) {
			$("#logcontainer_"+selectedLogContainerId).hide();
			$("#log_menu_item_"+selectedLogContainerId).removeClass("selected");
	
			$("#logcontainer_"+logId).show();
			$("#log_menu_item_"+logId).addClass("selected");
		}
		selectedLogContainerId = logId;
		
		$("#logcontainer_title").text(logContainers[selectedLogContainerId].name + " log messages:");
		var msg = "Shows " + logContainers[selectedLogContainerId].name + " log messages from " + deployments[selectedDeploymentId].name + " deployment.";
		$("#logcontainers").attr("title", msg);
	
		scrollPane = $("#logcontainer_"+logId).show().jScrollPane({showArrows:true,stickToBottom:true,horizontalGutter:10}).data('jsp');
		scrollPane.reinitialise();
		scrollPane.scrollToBottom();
		
		if (!logContainers[selectedLogContainerId].initialized) {
			$("#starttext").html('Loading ' + logContainers[selectedLogContainerId].name + ' log messages from ' + deployments[selectedDeploymentId].name + ' deployment... <img src="style/ajax-loader.gif" />');
			logContainers[selectedLogContainerId].initialized = true;
			getMaxLogsRecursive(logContainers[selectedLogContainerId], logContainers[selectedLogContainerId].firstTimestamp);
		}
		$("#starttext").html(msg);
	}
}

//]]>-->
</script>
</head>
<body>

<div id="container">
	<div id="header">
		<h1><a href="." id="gsn-name" style="display:none">GSN</a></h1>
	</div>
	<div id="navigation"></div>
	
	<div class="separator">
		<p id="starttext"></p>
	</div>
	
	
	<div id="maindiv" style="marging:5px 0">

		<div id="deployment_navigation">
		<ul id="deployment_menu" class="topnav">
		</ul>
        <img id="logsearch_clear" style="float:right;margin:5px;" src="img/button_cancel_grey.png" alt="clear filter" />
        <img id="logsearch_go" style="float:right;margin-top:6px;margin-left:5px;" src="img/button_go_grey.png" alt="clear filter" />
		<input id="logsearch" title="Enter search string to filter log messages" style="float:right;width:180px;margin-top:4px;border-style:inset;border-width:1px; " type="text"/>
		</div>
		
		<div id="logcontainer_title" style="text-align:left;margin:10px 0;font-weight:bold"></div>
		
		<div id="logcontainers"></div>
		
	</div>
	
	<div class="separator">
		<div id="footer">
		      <table width="100%">
				<tr>
					<td style="width:50%;color:#444444;"><b>A Project of <a href="http://www.ethz.ch" target="_blank">ETH Zurich</a>, <a href="http://www.unibas.ch" target="_blank">Uni Basel</a> and <a href="http://www.uzh.ch" target="_blank">Uni Zurich</a></b></td>
					<td style="text-align:right;width:50%;font-size:9px;">Powered by <a href="http://gsn.sourceforge.net/">GSN</a>,  Distributed Information Systems Lab, EPFL 2006</td>
				</tr>
			</table>
		</div>
	</div>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5632004-2");
pageTracker._initData();
pageTracker._trackPageview();
</script>
</body>
</html>
