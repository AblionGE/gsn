<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <title>GSN</title>

  <link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" />
  <link rel="stylesheet" href="style/tablesorter.css" type="text/css" media="screen,projection" />
  <script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="js/jquery-dom.js"></script>
  <script type="text/javascript" src="js/jquery.history.js"></script>
  <script type="text/javascript" src="js/jquery-tooltip.js"></script>
  <script type="text/javascript" src="js/jquery.cookie.js"></script>
  <script type="text/javascript" src="js/jquery.tablesorter.min.js"></script>

  <script type="text/javascript" src="js/constants.js"></script>
  <script type="text/javascript" src="js/functions.js"></script>
  <script type="text/javascript" src="js/uptime.js"></script>
  <script type="text/javascript" src="js/protovis-d3.3.js"></script>

<script type="text/javascript">
<!--//<![CDATA[

var deployments = new Array();
var deployment_data = new Array();
var current_deployment;
var selected_deployment;

var ACTIVE_TIMEOUT_MS = 2000;
var STANDBY_TIMEOUT_MS = 300000;

var rssi_dist = 25;
var topologyUpdateTimer;
var unmarkTimer;
var configitems=new Array("info","health","adcmux","adccomdiff","dcx","drift","events","rssi","statecounter","decagonmux","vaisala_wxt520", "powerswitch","powerswitch_p1","powerswitch_p2","timestamp");
var healthitems=new Array("packet_count", "vsys", "vsdi", "current", "temperature", "humidity","flash_count","uptime","generation_time","timestamp");

var GSN = {
  /**
    * iframe msg callback for webupload
    */
    msgcallback: function (msg,code) {
        $("#msg").html(msg);
        $("#msg").removeClass();
        if (code <= 200)
            $("#msg").addClass("good");
        else
            $("#msg").addClass("bad");
        $("#msg").append("<input style =\"margin-left:20px\" type=\"button\" value=\"OK\">");
        $("input[type=\"button\"]","#msg").bind("click", function () { $("#msg").hide(); $("#msg").empty();});
        $("#msg").show();
        resetconfigurations(true);
    }
}

function PacketRate() {
  this.packethistory = new Array();
  this.packetcount;
  this.rate = 0;
  
  this.update = function(packetcount) {
    if (!this.packetcount)
      this.packetcount=packetcount;
    var now=new Date().getTime();
    this.packethistory.push({rate : packetcount - this.packetcount, time : now});
    this.packetcount=packetcount;
    if (this.packethistory.length > 20)
      this.packethistory.shift();
    else if (this.packethistory.length == 1) {
      this.rate = parseFloat(0).toFixed(2);
      return;
    }
    var starttime=now, endtime=0, sum=0;
    $(this.packethistory).each(function(){
      sum = sum + this.rate;
      if (this.time < starttime) starttime = this.time;
      if (this.time > endtime) endtime = this.time;
    });
    this.rate = parseFloat((sum / (endtime-starttime) * 1000)).toFixed(2);
  }
  
}

  function nodeindex(id) {
    for (i=0;i<current_deployment.sensornodes.length;i++) {
      if (current_deployment.sensornodes[i].node_id==id)
        return i;
    }
    return -1;
  }

  function linkExists(links, testlink) {
    for (i=0;i<links.length;i++) {
      if (links[i].source==testlink.source && links[i].target==testlink.target && links[i].srcrssi==testlink.srcrssi && links[i].dstrssi==testlink.dstrssi)
        return true;
    }
    return false;
  }

  function updateGraph(network) {
    var topoloy_change=false;
    var oldlinks = current_deployment.links;
    current_deployment.links = new Array();
    $(current_deployment.sensornodes).each(function(index,value) {
      this.touched=false;
    });
    $("sensornode",network).each(function(){
      var id = $(this).attr("node_id");
      var index = nodeindex(id);
      if (index < 0) {
        current_deployment.sensornodes.push({node_id : $(this).attr("node_id"), timestamp :  $(this).attr("timestamp"), touched : true, nodetype: $(this).attr("nodetype"), corestation_running: $(this).attr("corestation_running") });
        topoloy_change = true;
      }
      else {
        current_deployment.sensornodes[index].timestamp = $(this).attr("timestamp");
        current_deployment.sensornodes[index].touched = true;
        current_deployment.sensornodes[index].nodetype = $(this).attr("nodetype");
        current_deployment.sensornodes[index].corestation_running = $(this).attr("corestation_running");
      }
    });
    var tmp = new Array();
    $(current_deployment.sensornodes).each(function(index,value) {
      if (this.touched)
        tmp.push(this);
      else {
        topoloy_change=true;
        removeIdFromTable(this.node_id);
      }
    });
    current_deployment.sensornodes = tmp;
    $("sensornode",network).each(function(){
      if ($(this).attr("parent_id")) {
        var src=nodeindex($(this).attr("node_id"));
        var dst=nodeindex($(this).attr("parent_id"));
        if (src >= 0 && dst >= 0) {
          var srclink = $("links", this).children("[node_id='"+$(this).attr("parent_id")+"']")[0];
          var dstlink = $($(network).children("[node_id='"+$(this).attr("parent_id")+"']")[0]).find("link[node_id='"+$(this).attr("node_id")+"']")[0];
          var newlink = {source : src, target: dst, srcrssi : $(srclink).attr("rssi"), dstrssi : $(dstlink).attr("rssi")};
          current_deployment.links.push(newlink);
          if (!linkExists(oldlinks, newlink))
            topoloy_change=true;
        }
      }
    });

    current_deployment.force.nodes(current_deployment.sensornodes);
    current_deployment.force.links(current_deployment.links);

    if (topoloy_change) {
      current_deployment.force.reset();
      current_deployment.force.iterations(100);
    }
    else {
      current_deployment.force.iterations(1);
    }
    current_deployment.vis.render();
  }

  function resetconfigurations(apply) {
    $(".configtable tbody>tr", "#topologycontainer").each(function() {
      if (!$(this).hasClass("disabled")) {
        $(this).addClass("disabled");
        $("td", this).each(function(){
          $("input:first", this).attr("disabled","true");
          if (!$("input:first",this).data("enabled_pending") || $("input:first",this).data("enabled")==$("input:first",this).data("enabled_pending"))
            $(this).removeClass("changing");
          // change if not equal
          if ($("input:first",this).data("enabled")=="true" && !$("input:first", this).attr("checked")) {
            $("input:first", this).attr("checked", "true");
            $("input:first", this).attr("name", "checked");
            if (apply)
              $(this).addClass("changing");
          }
          else if ($("input:first",this).data("enabled")=="false" && $("input:first", this).attr("checked")) {
            $("input:first", this).attr("checked", "");
            $("input:first", this).attr("name", "none");
            if (apply)
              $(this).addClass("changing");
          }
        });
      }                
    });
    $("form", "#topologycontainer").remove();
  }

  function expandNull(z, digits) {
    z = ""+z;
    for (var i = z.length; i<digits;i++)
      z = "0"+z;
    return z;
  }

  function formatTime(t) {
    if (!t)
      return "";
    else {      
      var d = new Date(0);
      d.setUTCMilliseconds(t);
      return (1900+d.getYear())+"-"+expandNull(d.getMonth()+1,2)+"-"+expandNull(d.getDate(),2)+" "+expandNull(d.getHours(),2)+":"+expandNull(d.getMinutes(),2)+":"+expandNull(d.getSeconds(),2)+" "+(d.getTimezoneOffset()<0?"+":"")+(-d.getTimezoneOffset()/60)+":00";
    }
  }

  function unmarkNewData() {
     $("tbody", "#topology_"+current_deployment.name).find("tr").each(function() {
      $(this).removeClass("newdata");
    });
  }

  function removeIdFromTable(id) {
    var table = $("tbody", "#topology_"+current_deployment.name);
    $("tr", table).each(function() {
      if ($(this).find(">:first-child").text()==id)
        $(this).remove();}
    );
  }

  function updateHealthTable(network) {
    var tablesorter = $("#topology_"+current_deployment.name).find(".healthtable table");;
    var table = tablesorter.find("tbody");
    var sortlist = $(tablesorter).get(0).config.sortList;
    if (sortlist.length == 0)
      sortlist = [[0,0]];
    var tableChanged = false;
    var now=new Date().getTime();
    $("sensornode",network).each(function(){
      var id = $(this).attr("node_id");
      var index = nodeindex(id);
      if (index < 0) {
        var cols='';
        for (i=0;i<healthitems.length;i++)
          cols+='<td></td>';
        table.append("<tr>"+
          "<td>"+parseInt($(this).attr("node_id"))+'</td>'+cols+'<td></td>'+
          "</tr>");
      }
      var row = $("td:first-child", table).filter(function(index) { return $(this).text()==id;}).parent();
      var data = this;
      if (index < 0 || ($(this).attr("timestamp") > current_deployment.sensornodes[index].timestamp)) {
        $("td", row).each(function(index,value) {
          switch (index) {
          case 0: break;
          case 2:
            var img;
            if (!$(data).attr('batterylevel'))
              img = 'none';
            else if ($(data).attr('batterylevel')<=5)
              img = 'empty';
            else if ($(data).attr('batterylevel')<=25)
              img = 'quarter';
            else if ($(data).attr('batterylevel')<=50)
              img = 'half';
            else
              img = 'full';
            $(this).empty().text($(data).attr(healthitems[index-1])?$(data).attr(healthitems[index-1]):"");
            $(this).append('<img style="margin:0px 0px 0px 5px;vertical-align:middle;" src="img/batterylevels/battery_'+img+'.png">');
            break;
          case 9:
          case 10:
            $(this).text(formatTime($(data).attr(healthitems[index-1])));
            break;
          case 11:
            break;
          default:
            $(this).text($(data).attr(healthitems[index-1])?$(data).attr(healthitems[index-1]):"");
            break;
          }
        });
        $(row).addClass("newdata");
        $(row).removeClass("offline");
        $("td:first-child", $("#topology_"+current_deployment.name).find(".configtable tbody")).filter(function(index) { return $(this).text()==id;}).parent().removeClass("offline");
        tableChanged = true;
      }
      if ($(this).attr("packet_count")) {
        if (!$(row).data("packetrate"))
          $(row).data("packetrate", new PacketRate());
        $(row).data("packetrate").update($(this).attr("packet_count"));
        $("td:last-child",row).text($(row).data("packetrate").rate);
      }
      if (now - $(data).attr("timestamp") > STANDBY_TIMEOUT_MS) {
        $(row).addClass("offline");
        $("td:first-child", $("#topology_"+current_deployment.name).find(".configtable tbody")).filter(function(index) { return $(this).text()==id;}).parent().addClass("offline");
      }
    });
    tablesorter.trigger("update");
    if (sortlist.length > 0)
      tablesorter.trigger("sorton", [sortlist]);
    if (tableChanged) {
      if (unmarkTimer)
        clearTimeout(unmarkTimer); 
      unmarkTimer = setTimeout("unmarkNewData()",500);
    }    
  }

  function updateConfigTable(network, isConfigurable) {
    var tablesorter = $("#topology_"+current_deployment.name).find(".configtable table");;
    var table = tablesorter.find("tbody");
    var sortlist = $(tablesorter).get(0).config.sortList;
    if (sortlist.length == 0)
      sortlist = [[0,0]];
    var tableChanged = false;
    var now=new Date().getTime();
    $("sensornode",network).each(function(){
      var id = $(this).attr("node_id");
      var index = nodeindex(id);
      if (index < 0) {
        table.append("<tr class=\"disabled\">"+
          "<td>"+parseInt($(this).attr("node_id"))+"</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>"+
          "<td></td><td></td><td></td><td></td><td></td></tr>");
        if (isConfigurable)
        $("tr:last", table).bind("click",function() {
          if (!$(this).hasClass("disabled"))
            return;
          $("input",this).each(function(){
            $(this).removeAttr("disabled");
            $(this).bind("change", function() {
              if ($(this).attr("checked"))
                $(this).attr("name", "checked");
              else
                $(this).attr("name", "none");
            });
          });
          $(this).removeClass("disabled");
          if ($(".configtab input", "#topology_"+current_deployment.name).length==0) {
            // add config form
            var configtab = $(".configtab", "#topology_"+current_deployment.name);
            configtab.append("<form action=\"/upload\" method=\"post\" enctype=\"multipart/form-data\" target=\"webupload\">"+
                "<input type=\"submit\" value=\"apply\">"+
                "<input type=\"button\" value=\"reset\">"+
                "<input type=\"hidden\" name=\"vsname\" value=\""+current_deployment.topology_vs_name+"\">"+
                "<input type=\"hidden\" name=\"cmd\" value=\"dataconfiguration\">"+
                "<input type=\"hidden\" name=\"dataconfiguration;configuration\" value=\"\">"+
                "</form>"
            );
            $("input:first", configtab).bind("click", function () {
              // generate xml configuration
              var generated_config="<?xml version=\"1.0\" encoding=\"UTF-8\"?><network><sensornodes>";
              $(".configtable tbody>tr", "#topology_"+current_deployment.name).each(function() {
                if (!$(this).hasClass("disabled")) {
                  generated_config=generated_config+"<sensornode node_id=\""+$("td:first-child",this).text()+"\"><links />";
                  var c = "";
                  $("td", this).each(function(index,value) {
                    switch (index) {
                    case 0: break;
                    case 2: // always enable health ..
                    case 7: //  .. and event packets
                      c = c + " "+configitems[index-1]+"=\"true\"";
                      break;
                    case 15: break;
                    default:
                      if ($(this).children().length > 0)
                        c = c + " "+configitems[index-1]+"=\"" + ($("input:first", this).attr("checked")?"true":"false")+"\"";
                    }
                  });
                  if (c.length>0)
                    generated_config=generated_config+"<configuration "+$.trim(c)+" />";
                  generated_config=generated_config+"</sensornode>";
                }
              });
              generated_config=generated_config+"</sensornodes></network>";
              $("#debug").append(generated_config);
              $("input[name='dataconfiguration;configuration']", configtab).attr("value", generated_config);
              // submit
              $("form", configtab).submit();
            });
            // bind reset button
            $("input[type='button']", configtab).bind("click", function () {
              resetconfigurations(false);
            });
          }
          
        });
        $("tr:last", table).hover(function() { $(this).parent().children().each(function(){$(this).removeClass("selected")});$(this).addClass("selected"); }, function() { $(this).removeClass("selected"); });
      }
      var row = $("td:first-child", table).filter(function(index) { return $(this).text()==id;}).parent();
      var hasConfig = $("configuration", this).length>0;
      var hasPendingConfig = $("pendingConfiguration", this).length>0;
      var update=false;
      var timestamp;
      if (hasConfig) {
        // do we need to update?
        if (!$(row).data("hasConfig") || $(row).data("hasConfig")!=hasConfig)
          update=true;
        else if (hasPendingConfig && (!$(row).data("hasPendingConfig") || $(row).data("hasPendingConfig")!=hasPendingConfig))
          update=true;
        else if ($(row).data("hasPendingConfig") && !hasPendingConfig)
          update=true;
        else {
          if ($("configuration",this).attr("timestamp"))
            timestamp = $("configuration",this).attr("timestamp");
          if ($("pendingConfiguration",this).attr("timestamp") && (!timestamp || $("pendingConfiguration",this).attr("timestamp")>timestamp))
            timestamp = $("pendingConfiguration",this).attr("timestamp");
          if (!row.data("timestamp") || row.data("timestamp") < timestamp) {
            update=true;
            row.data("timestamp", timestamp);
          }
        }
        $(row).data("hasConfig",hasConfig);
        if (!hasPendingConfig)
          $(row).data("hasPendingConfig","");
        else
          $(row).data("hasPendingConfig",hasPendingConfig);
      }
      if (update) {
        var data = $("configuration",this);
        $("td", row).each(function(index,value) {
            switch (index) {
            case 0: break;
            case 15:
              $(this).text(formatTime($(data).attr(configitems[index-1])));
              break;
            default:
              if ($(data).attr(configitems[index-1])) {
                // fill empty cell
                if ($(this).children().length == 0) {
                  $(this).append("<div><input type=\"checkbox\" disabled=\""+($(this).parent().hasClass("disabled")?"disabled":"")+"\"></div>");                  
                }
                $("input:first", this).data("enabled", $(data).attr(configitems[index-1]));
                var pending = $(data).parent().children("pendingConfiguration");
                if (pending.length>0 && pending.attr(configitems[index-1]))
                  $("input:first", this).data("enabled_pending", pending.attr(configitems[index-1]));
                else
                  $("input:first", this).data("enabled_pending","");
                if ($(this).parent().hasClass("disabled")) { // if not changeable, just update
                  if (pending.length>0 && pending.attr(configitems[index-1]) && pending.attr(configitems[index-1]) != $(data).attr(configitems[index-1]))
                    $(this).addClass("changing");
                  else
                    $(this).removeClass("changing");
                  $("input:first", this).attr("checked", $(data).attr(configitems[index-1])=="true"?"checked":"");
                  $("input:first", this).attr("name", $(data).attr(configitems[index-1])=="true"?"checked":"none");
                }
                else {// compare to current status
                  if ($("input:first", this).attr("checked") && $(data).attr(configitems[index-1])=="true" ||
                      !$("input:first", this).attr("checked") && $(data).attr(configitems[index-1])=="false")
                    $(this).removeClass("changing");
                  else
                    $(this).addClass("changing");
                }
              }
              else {
                // remove content
                $(this).empty();
              }
              break;
            }
        });
        $(row).addClass("newdata");
        tableChanged = true;
      }
    });
    if (tableChanged) {
      tablesorter.trigger("update");
      if (sortlist.length > 0)
        tablesorter.trigger("sorton", [sortlist]);
      if (unmarkTimer)
        clearTimeout(unmarkTimer); 
      unmarkTimer = setTimeout("unmarkNewData()",500);
    }    
  }

  function updateStatusBar(network) {
    var packetcount = 0;
    var nodeonlinecount = 0;
    var nodetotalcount = 0;
    var now=new Date().getTime();
    $("sensornode",network).each(function(){
      packetcount = packetcount+parseInt($(this).attr("packet_count"));
      nodetotalcount = nodetotalcount + 1;
      if (now - $(this).attr("timestamp") <= STANDBY_TIMEOUT_MS)
        nodeonlinecount = nodeonlinecount + 1;
    });
    current_deployment.packethistory.update(packetcount);
    $(".statusbar", "#topology_"+current_deployment.name).empty();
    $(".statusbar", "#topology_"+current_deployment.name).append("Total: "+nodetotalcount+"<br>Online: "+nodeonlinecount+"<br>Packetrate: "+current_deployment.packethistory.rate+" Pkts/s");
  }

  function fetchTopologyInfo() {
    if (!current_deployment.isUpdating) {
      current_deployment.isUpdating = true;
      $.ajax({
        type: "GET",
        url: "/field?vs="+current_deployment.topology_vs_name+"&field=DATA&pk=latest",
        dataType: "xml",
        success: function(data){
          updateConfigTable($("sensornodes",data), $("network", data).attr("configurable")=="true");
          updateHealthTable($("sensornodes",data));
          updateGraph($("sensornodes",data));
          updateStatusBar($("sensornodes",data));
          current_deployment.isUpdating = false;
          current_deployment = selected_deployment;
          topologyUpdateTimer = setTimeout("fetchTopologyInfo()",5000);
        },
        error : function(XMLHttpRequest, textStatus, errorThrown) {
          current_deployment.isUpdating = false;
          current_deployment = selected_deployment;
          topologyUpdateTimer = setTimeout("fetchTopologyInfo()",10000);
        }
      });    
    }
  }

$(document).ready(function() {

  $("#navigation ul a.local").bind("click",function() { return GSN.nav($(this).text()); });

  // load deployments
  $.ajax({
    type: "GET",
    url: "/gsn?structure",
    success: function(data){
      if ($(document).attr("title")=="GSN") {
        var gsn = $("gsn",data);
        $(document).attr("title",$(gsn).attr("name"));
        $("#gsn-name").empty().append($(gsn).attr("name"));
        $("#gsn-desc").empty().append($(gsn).attr("description"));
        $("#gsn-author").empty().append($(gsn).attr("author")+" ("+$(gsn).attr("email")+")");
      }
      $("#gsn-name").show();
      uptime.setTime($(gsn).attr("uptime"));
      var topology_vs_name = new Array();
      var arraySize = 0;
      $("virtual-sensor",data).each(function(){
        var deploymentname = $(this).attr("name").split("_", 1)[0];
        var groupname = $(this).attr("name").split("_", 2)[1];
        deploymentname = deploymentname.substring(0, 1).toUpperCase() + deploymentname.substring(1, deploymentname.length).toLowerCase();
        if(deploymentname.length > 1 && deploymentname!='Statistics') {
          if ($.inArray(deploymentname, deployments) < 0)
            deployments.push(deploymentname);
          if (groupname == "topology") {
            var i = $.inArray(deploymentname, deployments);
              if (i>-1)
                topology_vs_name[i]=$(this).attr("name");
          }
        }                    
      });
      // display
      var visible;
      if ($.inArray($.cookie("deployment"), deployments)>-1)
        visible = $.cookie("deployment");
      else
        visible = deployments[0];
      for (var i in deployments) {
        // add tab
        $("#deployment_menu").append($.LI({}, $.A({
          "id":"deployment_menu_item_"+deployments[i],
          "href":"javascript:showTopology("+i+")"
          },deployments[i])));
        // add div
        $("#topologycontainer").append("<div style=\"position:relative\" id=\"topology_"+deployments[i]+"\"><div style=\"position:absolute;text-align:left\"class=\"statusbar\"></div><div id=\"topology_graph_"+deployments[i]+"\"></div><div class=\"healthtable\"></div><div class=\"configtable\" style=\"display:none\"></div>"+
            "<ul class=\"tabnav\" style=\"padding-top:0px\"><li><a class =\"active healthtab\" href=\"\">Health</a></li><li><a class =\"configtab\" href=\"\">Configuration</a></li></ul></div>");
        if (deployments[i]!=visible)
          $("#topology_"+deployments[i]).hide();
        else
          $("#deployment_menu_item_"+deployments[i]).addClass("selected");
        // add graph
        deployment_data.push({
          name : deployments[i],
          topology_vs_name : topology_vs_name[i],
          sensornodes : new Array(),
          links : new Array(),
          isUpdating : false,
          packethistory : new PacketRate(),
          vis : new pv.Panel()
            .width(700)
            .height(300)
            .fillStyle("white")
            .canvas("topology_graph_"+deployments[i])
        });
        deployment_data[deployment_data.length-1].force =
          deployment_data[deployment_data.length-1].vis
            .add(pv.Layout.Force)
            .springLength(70)
            .bound(true)
            .chargeConstant(-200)
            .springConstant(.4)
            .link.add(pv.Line).parent.add(pv.Label)
            .text(function(d) {
              return d.srcrssi;
            })
            .left(function(l) {
              var x = l.targetNode.px - l.sourceNode.px;
              var y = l.targetNode.py - l.sourceNode.py;
              var f = rssi_dist / Math.sqrt(Math.pow(y,2)+Math.pow(x,2))
              return l.sourceNode.px + x * f-12;
            })
            .top(function(l) {
              var x = l.targetNode.px - l.sourceNode.px;
              var y = l.targetNode.py - l.sourceNode.py;
              var f = rssi_dist / Math.sqrt(Math.pow(y,2)+Math.pow(x,2))
              return l.sourceNode.py + y * f+8;
            })
            .parent.add(pv.Label)
            .text(function(d) {
              return d.dstrssi;
            })
            .left(function(l) {
              var x = l.sourceNode.px - l.targetNode.px;
              var y = l.sourceNode.py - l.targetNode.py;
              var f = rssi_dist / Math.sqrt(Math.pow(y,2)+Math.pow(x,2))
              return l.targetNode.px + x * f-12;
            })
            .top(function(l) {
              var x = l.sourceNode.px - l.targetNode.px;
              var y = l.sourceNode.py - l.targetNode.py;
              var f = rssi_dist / Math.sqrt(Math.pow(y,2)+Math.pow(x,2))
              return l.targetNode.py + y * f+8;
            })
            .parent.parent;
        deployment_data[deployment_data.length-1].node =
          deployment_data[deployment_data.length-1].force
            .node.add(pv.Dot)
            .shape(function(d) {return d.nodetype==3 || d.nodetype==1?"square":"circle"; })
            .shapeSize(function(d) {return 230;})
            .fillStyle(function(d) {
              var now=new Date().getTime();
              if (now - d.timestamp > STANDBY_TIMEOUT_MS)
                return "#ffa0a0";
              else if (now - d.timestamp > ACTIVE_TIMEOUT_MS)
                return "#a0c0a0";
              else
                return "#a0ffa0";
            })
            .strokeStyle(function() {return this.fillStyle().darker()})
            .lineWidth(function(d) { return d.nodetype==1?5:(d.corestation_running=="true"?5:1); }); /*
            .event("mousedown", pv.Behavior.drag())
            .event("drag", deployment_data[deployment_data.length-1].force);*/
        deployment_data[deployment_data.length-1].force
          .label.add(pv.Label)
          .text(function(d) {return d.node_id;})
          .font(function() {return "bold 11px sans-serif";});
        // add parser for sorting
        $.tablesorter.addParser({ 
          // set a unique id 
          id: 'checkbox', 
          is: function(s) { 
            // return false so this parser is not auto detected 
            return false; 
          }, 
          format: function(s) { 
            // format your data for normalization 
            var test = s;
            if (s.length==0)
              return 0;
            else if (s.indexOf("checked")==-1)
              return 1;
            else
              return 2;
          }, 
          // set type, either numeric or text 
          type: 'numeric' 
        }); 
        // add health table
        $($(".healthtable", "#topology_"+deployments[i])[0]).append("<table class=\"tablesorter\" border=\"0\" cellpadding=\"0\" cellspacing=\"1\"><thead><tr>"+
            "<th class=\"header\" style=\"width:30px\">ID</th>"+
            "<th class=\"header\">Pkt Count</th>"+
            "<th class=\"header\">Vsys</th>"+
            "<th class=\"header\">Vsdi</th>"+
            "<th class=\"header\">I</th>"+
            "<th class=\"header\">Temp</th>"+
            "<th class=\"header\">Hum</th>"+
            "<th class=\"header\">Flash Count</th>"+
            "<th class=\"header\">Uptime</th>"+
            "<th class=\"header\">Generation Time</th>"+
            "<th class=\"header\">Timestamp</th>"+
            "<th class=\"header\">Packetrate</th>"+
            "</tr></thead><tbody></tbody></table>");
        $("#topology_"+deployments[i]).find(".healthtable table").tablesorter({ 
          widthFixed: true,
          headers:
            { 
              0: { sorter: 'digit' },
              1: { sorter: 'digit' },
              2: { sorter: 'digit' },
              3: { sorter: 'digit' },
              4: { sorter: 'digit' },
              5: { sorter: 'digit' },
              6: { sorter: 'digit' },
              7: { sorter: 'digit' },
              8: { sorter: 'digit' },
              11: { sorter: 'digit' }
            } 
        });
        // add config table
        $($(".configtable", "#topology_"+deployments[i])[0]).append("<table class=\"tablesorter\" border=\"0\" cellpadding=\"0\" cellspacing=\"1\"><thead><tr>"+
            "<th class=\"header\" style=\"width:30px\">ID</th>"+
            "<th class=\"header\">info</th>"+
            "<th class=\"header\">health</th>"+
            "<th class=\"header\">adcmux</th>"+
            "<th class=\"header\">adccomdiff</th>"+
            "<th class=\"header\">dcx</th>"+
            "<th class=\"header\">drift</th>"+
            "<th class=\"header\">events</th>"+
            "<th class=\"header\">rssi</th>"+
            "<th class=\"header\">statecounter</th>"+
            "<th class=\"header\">decagonmux</th>"+
            "<th class=\"header\">vaisala</th>"+
            "<th class=\"header\">powerswitch</th>"+
            "<th class=\"header\">p1</th>"+
            "<th class=\"header\">p2</th>"+
            "<th class=\"header\">Timestamp</th>"+
            "</tr></thead><tbody></tbody></table>");
        $("#topology_"+deployments[i]).find(".configtable table").tablesorter({ 
          widthFixed: true,
          headers:
            { 
              0: { sorter: 'digit' },
              1: { sorter: 'checkbox' },
              2: { sorter: 'checkbox' },
              3: { sorter: 'checkbox' },
              4: { sorter: 'checkbox' },
              5: { sorter: 'checkbox' },
              6: { sorter: 'checkbox' },
              7: { sorter: 'checkbox' },
              8: { sorter: 'checkbox' },
              9: { sorter: 'checkbox' },
              10: { sorter: 'checkbox' },
              11: { sorter: 'checkbox' },
              12: { sorter: 'checkbox' },
              13: { sorter: 'checkbox' },
              14: { sorter: 'checkbox' },
            } 
        });
        // add status bar
        if (deployments[i]==visible) {
          selected_deployment=deployment_data[i];
          current_deployment=deployment_data[deployment_data.length-1];
          current_deployment.force.nodes(current_deployment.sensornodes);
          current_deployment.force.links(current_deployment.links)
          current_deployment.vis.render();
        }
        // bind tabs
        $("#topology_"+deployments[i]).find(".configtab").click(function() { 
          var thiscontainer = $(this).parent().parent().parent();
          thiscontainer.find(".configtable").show();
          thiscontainer.find(".healthtable").hide();
          $(this).addClass("active");
          thiscontainer.find(".healthtab").removeClass("active");
          return false;
        });
        $("#topology_"+deployments[i]).find(".healthtab").click(function() { 
          var thiscontainer = $(this).parent().parent().parent();
          thiscontainer.find(".healthtable").show();
          thiscontainer.find(".configtable").hide();
          $(this).addClass("active");
          thiscontainer.find(".configtab").removeClass("active");
          resetconfigurations(false);
          return false;
        });
      }
      topologyUpdateTimer = setTimeout("fetchTopologyInfo()",100);
    }
  });
});

function showTopology(id) {
  for (var i in deployments) {
    $("#topology_"+deployments[i]).hide();
    $("#deployment_menu_item_"+deployments[i]).removeClass("selected");
  }
  $("#topology_"+deployments[id]).show();
  $("#deployment_menu_item_"+deployments[id]).addClass("selected");
  $.cookie("deployment" , deployments[id]);
  selected_deployment = deployment_data[id];
  if (!current_deployment.isUpdating) {
    unmarkNewData();
    current_deployment = selected_deployment;
    clearTimeout(topologyUpdateTimer); 
    topologyUpdateTimer = setTimeout("fetchTopologyInfo()",100);
  }
}
//]]>-->
</script>
</head>
<body>

<div id="container">
	<div id="header">
		<h1><a href="." id="gsn-name" style="display:none">GSN</a></h1>
	</div>
	<div id="navigation">
		<ul id="menu">
			<li><a href="index.html#home">home</a></li>
			<li><a href="data.html#data">data browser</a></li>
			<li class="selected"><a href="topology.html#topology">network topology</a></li>
			<li><a href="nodehealth.html#nodehealth">node health</a></li>
            <li><a href="basehealth.html#basehealth">base health</a></li>
			<li><a href="weather.html#weather">on-site weather</a></li>
			<li><a href="map.html#map">map</a></li>
            <!-- <li><a href="fullmap.html#fullmap">fullmap</a></li> -->
		</ul>
		<ul id="linkWebsite"><li><a href="http://www.permasense.ch" target="_blank">PermaSense Home</a></li></ul>
	</div>
		
	<div id="maindiv">
                <div id="msg" style="display:none"></div>
                <iframe name="webupload" style="border:0;height:0;width:0;"></iframe>
		<div id="deployment_navigation">
		<ul id="deployment_menu"></ul>
		</div>	
		<div id="topologycontainer" style="margin-top:5px"></div>
	</div>
	<div class="separator">
		<div id="footer">
		      <table width="100%">
				<tr>
					<td style="width:50%;color:#444444;"><b>A Project of <a href="http://www.ethz.ch" target="_blank">ETH Zurich</a>, <a href="http://www.unibas.ch" target="_blank">Uni Basel</a> and <a href="http://www.uzh.ch" target="_blank">Uni Zurich</a></b></td>
					<td style="text-align:right;width:50%;font-size:9px;">Powered by <a href="http://gsn.sourceforge.net/">GSN</a>,  Distributed Information Systems Lab, EPFL 2006</td>
				</tr>
			</table>
		</div>
	</div>
</div>
<div id="debug"></div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5632004-2");
pageTracker._initData();
pageTracker._trackPageview();
</script>
</body>
</html>
