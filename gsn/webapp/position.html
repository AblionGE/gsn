
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"> 
<head> 
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" /> 
		<title>GSN</title> 
		
		<link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" /> 
		<script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
		<script type="text/javascript" src="js/jquery-dom.js"></script> 
		<script type="text/javascript" src="js/jquery.history.js"></script> 
		<script type="text/javascript" src="js/jquery-tooltip.js"></script> 
		<script type="text/javascript" src="js/jquery.cookie.js"></script>
		
		<!-- Include Map engine-->
		<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAcCxhFM99SMIShXVUlt9hZRQoXGUTEdpbmrAyx2JlHCxqhxsghhQSegHWMdlkJ2KgyDZ4MV_erdujug" type="text/javascript"></script>
		<script type="text/javascript" src="js/mapstraction.js"></script>
		
		<script type="text/javascript" src="js/constants.js"></script>
		<script type="text/javascript" src="js/functions.js"></script>
		<script type="text/javascript" src="js/gsn.js"></script>
		<script type="text/javascript" src="js/uptime.js"></script>

<script type="text/javascript">
<!--//<![CDATA[
		
	var mapProvider = null;
	var topologyUpdateInfo;
	
	var deployments = new Array();
	var selectedDeploymentNr;
	var tableEnding = "";
	var fieldIdLat = "lat_raw_data";
	var fieldIdLong = "long_raw_data";
		
function deployment(name) {
	this.name = name;
}

function showDeployment(id) {
	$.each(deployments, function() {
		var depl = this;
		$("#deployment_"+depl.name).hide();
		$("#deployment_menu_item_"+depl.name).removeClass("selected");
	});
	$("#deployment_"+deployments[id].name).show();
	$("#deployment_menu_item_"+deployments[id].name).addClass("selected");
	$.cookie("deployment" , deployments[id].name);
	selectedDeploymentNr = id;
}

$(document).ready(function() {

	$.get('/menu.jsp', {selected: "position"}, function(data) {
		$('#navigation').html(data);
	}, 'html');
	$("#navigation ul a.local").bind("click",function() { return GSN.nav($(this).text()); });
		
	// deployments
	// load deployments
	$.ajax({
		type: "GET",
		url: "/gsn?structure",
		success: function(data){
			if ($(document).attr("title")=="GSN") {
			    var gsn = $("gsn",data);
			    $(document).attr("title",$(gsn).attr("name"));
			    $("#gsn-name").empty().append($(gsn).attr("name"));
			    $("#gsn-desc").empty().append($(gsn).attr("description"));
			    $("#gsn-author").empty().append($(gsn).attr("author")+" ("+$(gsn).attr("email")+")");
			    var gsnname = $(gsn).attr("name").replace(/.*::\s*GSN\s*-\s*/, "").replace(/\s/g,"").toLowerCase();
			    $('head', document).append('<link rel="shortcut icon" href="/img/favicon/permasense-'+gsnname+'.ico"><link rel="icon" href="/img/favicon/permasense-'+gsnname+'.ico">');
			}
			$("#gsn-name").show();
			uptime.setTime($(gsn).attr("uptime"));
			var arraySize = 0;
			$("virtual-sensor",data).each(function(){
				if ($(this).attr("name").indexOf("gps_nav") != -1) {
					if ($(this).attr("name").indexOf("__mapped") != -1) {
						tableEnding = "__mapped";
						fieldIdLat = "latitude";
						fieldIdLong = "longitude";
					}
			    var deploymentname = $(this).attr("name").split("_", 1)[0];
			    if(deploymentname.length > 1) {
						deploymentname = deploymentname.substring(0, 1).toUpperCase() + deploymentname.substring(1, deploymentname.length).toLowerCase();
						if (deploymentname!='Statistics') {
							var exists = false;
							$.each(deployments, function(){
								if (this.name == deploymentname) {
									exists = true;
									return false;
								}
							});
							if (!exists)
						  	deployments.push(new deployment(deploymentname));
						}
					}
				}
			});
			// display
			var visible = 0;
			$.each(deployments, function(i, l){
				if (this.name == $.cookie("deployment")) {
					visible = i;
					return false;
				}
			});
			
			$.each(deployments, function(i, depl) {
			    // add tab
			    $("#deployment_menu").append($.LI({}, $.A({
				"id":"deployment_menu_item_"+depl.name,
				"href":"javascript:showDeployment("+i+")"
			    },depl.name)));
				
				$("#deployment_"+depl.name).hide();
			});
			showDeployment(visible);
		  
		  $("#starttext").html("<p>CoreStation GPS position.</p>");
		  
		  mapProvider = DEFAULT_MAP_PROVIDER;
			map = new Mapstraction('vsmap',mapProvider);
	
	    //bind every buttons to javascript functionality (only once)
	    $("#refreshall_timeout").bind("change",GSN.updateallchange);
	    $("#refreshall").bind("click",GSN.updateall);
	    $("#toggleallmarkers").bind("click()",GSN.map.toggleAllMarkers);
	    $("#navigation ul a.local").bind("click",function() { return GSN.nav($(this).text()); });
	
	    GSN.load();
	    GSN.map.toggleAllMarkers();
	    topologyUpdateTimer = setTimeout("fetchTopologyInfo", 10000);
	    fetchTopologyInfo();
	    GSN.map.showAllMarkers();
		  
		}
	});
});

function fetchTopologyInfo() {

	var seldepl = selectedDeploymentNr;

	$.ajax({
		type: "GET",
		url: "/data?vsName=" + deployments[seldepl].name.toLowerCase() + "_gps_nav" + tableEnding + "&fields=device_id&fields=" + fieldIdLong + "&fields=" + fieldIdLat + "&critfield=device_id&neg=&critop==&critval=1&nb=1",
		    async: false,
		    cache: false,
		    timeout: 30000,
		success: function(data){
			var dev_id = "";
			var lati;
			var longi;
			$("line", data).each(function(){
				if ($("field:eq(0)", this).text() != "device_id") {
					dev_id = $("field:eq(0)", this).text();
					longi = $("field:eq(1)", this).text();
					lati = $("field:eq(2)", this).text();
					
					var absdlat = Math.abs( Math.round(Math.round(lati/100) * 1000000.));
					var absmlat = Math.abs( Math.round((lati - absdlat/10000) * 1000000.));
		
					var absdlon = Math.abs( Math.round(Math.round(longi/100) * 1000000.));
					var absmlon = Math.abs( Math.round((longi - absdlon/10000) * 1000000.));
		
					lati = Math.round(absdlat + (absmlat/60.) ) * 1/1000000;
					longi = Math.round(absdlon + (absmlon/60.) ) * 1/1000000;
		
					GSN.map.updateMarker(deployments[seldepl].name.toLowerCase() + "_gps_nav" + tableEnding, dev_id, lati, longi);
				}
			})
		}
	});
	
	$.ajax({
		type: "GET",
		url: "/data?vsName=" + deployments[seldepl].name.toLowerCase() + "_gps_nav" + tableEnding + "&fields=device_id&fields=" + fieldIdLong + "&fields=" + fieldIdLat + "&critfield=device_id&neg=&critop==&critval=2&nb=1",
		    async: false,
		    cache: false,
		    timeout: 30000,
		success: function(data){
			var dev_id = "";
			var lati;
			var longi;
			$("line", data).each(function(){
				if ($("field:eq(0)", this).text() != "device_id") {
					dev_id = $("field:eq(0)", this).text();
					longi = $("field:eq(1)", this).text();
					lati = $("field:eq(2)", this).text();
					
					var absdlat = Math.abs( Math.round(Math.round(lati/100) * 1000000.));
					var absmlat = Math.abs( Math.round((lati - absdlat/10000) * 1000000.));
		
					var absdlon = Math.abs( Math.round(Math.round(longi/100) * 1000000.));
					var absmlon = Math.abs( Math.round((longi - absdlon/10000) * 1000000.));
		
					lati = Math.round(absdlat + (absmlat/60.) ) * 1/1000000;
					longi = Math.round(absdlon + (absmlon/60.) ) * 1/1000000;
		
					GSN.map.updateMarker(deployments[seldepl].name.toLowerCase() + "_gps_nav" + tableEnding, dev_id, lati, longi);
				}
			})
			GSN.load();
			topologyUpdateTimer = setTimeout("fetchTopologyInfo()",10000);
		},
		error : function(XMLHttpRequest, textStatus, errorThrown) {
			topologyUpdateTimer = setTimeout("fetchTopologyInfo()",60000);
		}
	});
	
};

function showDeployment(id) {
	$.each(deployments, function() {
		var depl = this;
		$("#deployment_"+depl.name).hide();
		$("#deployment_menu_item_"+depl.name).removeClass("selected");
	});
	$("#deployment_"+deployments[id].name).show();
	$("#deployment_menu_item_"+deployments[id].name).addClass("selected");
	$.cookie("deployment" , deployments[id].name);
	selectedDeploymentNr = id;
}

//]]>-->
        </script>




    </head>
    <body onunload="">
    

        <div id="container">
            <div id="header">
                <h1><a href="." id="gsn-name" style="display:none">GSN</a></h1>
            </div>
            
            
            <div id="navigation">
            </div>
            
            <div id="separator">
							<div id="starttext" />
						</div>
						
						<div id="maindiv">

							<div id="deployment_navigation">
							<ul id="deployment_menu">
							<li />
							</ul>
							</div>
							
							<!-- map part -->
              <div id="mapdiv">

                  <p><a style="text-decoration:underline" href="javascript:GSN.map.showAllMarkers();">Auto-zoom and focus the map</a></p>
                  <div id="vsmap" style="width: 100%; height: 500px; position:relative;"></div>
                  <div id="vs4map"></div>
              </div>
							
						</div>
            
	<div class="separator">
		<div id="footer">
		      <table width="100%">
				<tr>
					<td style="width:50%;color:#444444;"><b>A Project of <a href="http://www.ethz.ch" target="_blank">ETH Zurich</a>, <a href="http://www.unibas.ch" target="_blank">Uni Basel</a> and <a href="http://www.uzh.ch" target="_blank">Uni Zurich</a></b></td>
					<td style="text-align:right;width:50%;font-size:9px;">Powered by <a href="http://gsn.sourceforge.net/">GSN</a>,  Distributed Information Systems Lab, EPFL 2006</td>
				</tr>
			</table>
		</div>
	</div>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5632004-2");
pageTracker._initData();
pageTracker._trackPageview();
</script>
</body>
</html>
