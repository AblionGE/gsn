<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <title>GSN</title>
        
        <link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" />
        
        <script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
        <script type="text/javascript" src="js/jquery-dom.js"></script> 
        <script type="text/javascript" src="js/jquery.history.js"></script> 
        <script type="text/javascript" src="js/jquery-tooltip.js"></script> 
        <script type="text/javascript" src="js/jquery.cookie.js"></script>
        
        <script type="text/javascript" src="js/constants.js"></script>
        <script type="text/javascript" src="js/functions.js"></script>
        <script type="text/javascript" src="js/gsn.js"></script>
        <script type="text/javascript" src="js/uptime.js"></script>
        
        <link rel="stylesheet" type="text/css" href="http://whymper.ethz.ch:24001/vizzly.min.css" />
        <link rel="stylesheet" type="text/css" href="http://whymper.ethz.ch:24001/extlib/jquery-ui-1.8.20.custom.css" />
        <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
        <!--script type='text/javascript' src='http://whymper.ethz.ch:24001/extlib/jquery-1.6.2.min.js'></script-->
        <script type='text/javascript' src='http://whymper.ethz.ch:24001/extlib/jquery-ui-1.8.20.custom.min.js'></script>
        <script type='text/javascript' src='http://whymper.ethz.ch:24001/extlib/jquery.ui.touch-punch.min.js'></script>
        <script type='text/javascript' src='http://whymper.ethz.ch:24001/extlib/dygraph-combined.js'></script>
        <script type='text/javascript' src='http://whymper.ethz.ch:24001/vizzly.min.js'></script>
      

<script type="text/javascript">
<!--//<![CDATA[

var g1Config = null;

var topologyUpdateInfo;
var LOOK_N_MIN_BACK = 5;
var deployments = new Array();
var selectedDeploymentNr;
var tableEnding = "";
var fieldIdLat = "lat_raw_data";
var fieldIdLong = "long_raw_data";
var coreStationFieldId = "device_id";

var aggMap;
    
function deployment(name) {
  this.name = name;
  this.coreStations = new Array();
}

function coreStation(id) {
  this.id = id;
  this.marker = new google.maps.Marker();
}

function getCoreStationIds(deploymentId) {
  var date = new Date((new Date()).getTime()-(LOOK_N_MIN_BACK*60000));
  var ids = new Array();
  $.ajax({
    type: "GET",
    url: "/data?vsName=" + deployments[deploymentId].name.toLowerCase() + "_gps_nav" + tableEnding + "&fields=" + coreStationFieldId + "&orderby=timestamp&groupby=" + coreStationFieldId + "&critfield=timestamp&neg=&critop=%3E&critval=" + date.getTime(),
        async: false,
        cache: false,
        timeout: 30000,
    success: function(data){
      $("line", data).each(function(){
        var l = $("field", this).text();
        if (l != coreStationFieldId && l.toLowerCase() != "null")
          ids.push(new coreStation(l))
      });
    }
  });
  return ids;
}

function showDeployment(id) {
  $.each(deployments, function() {
    var depl = this;
    $("#deployment_"+depl.name).hide();
    $("#deployment_menu_item_"+depl.name).removeClass("selected");
  });
  $("#deployment_"+deployments[id].name).show();
  $("#deployment_menu_item_"+deployments[id].name).addClass("selected");
  $.cookie("deployment" , deployments[id].name);
  selectedDeploymentNr = id;
}

function addNewCoreStation(depl, id) {
  var cs = new coreStation(id);
  
  depl.coreStations.push(cs)
}

$(document).ready(function() {

  $.get('/menu.jsp', {selected: "position"}, function(data) {
    $('#navigation').html(data);
  }, 'html');
  $("#navigation ul a.local").bind("click",function() { return GSN.nav($(this).text()); });
    
  // deployments
  // load deployments
  $.ajax({
    type: "GET",
    url: "/gsn?structure",
    success: function(data){
      if ($(document).attr("title")=="GSN") {
          var gsn = $("gsn",data);
          $(document).attr("title",$(gsn).attr("name"));
          $("#gsn-name").empty().append($(gsn).attr("name"));
          $("#gsn-desc").empty().append($(gsn).attr("description"));
          $("#gsn-author").empty().append($(gsn).attr("author")+" ("+$(gsn).attr("email")+")");
          var gsnname = $(gsn).attr("name").replace(/.*::\s*GSN\s*-\s*/, "").replace(/\s/g,"").toLowerCase();
          $('head', document).append('<link rel="shortcut icon" href="/img/favicon/permasense-'+gsnname+'.ico"><link rel="icon" href="/img/favicon/permasense-'+gsnname+'.ico">');
      }
      $("#gsn-name").show();
      uptime.setTime($(gsn).attr("uptime"));
      var arraySize = 0;
      $("virtual-sensor",data).each(function(){
        if ($(this).attr("name").indexOf("gps_nav") != -1) {
          if ($(this).attr("name").indexOf("__mapped") != -1) {
            tableEnding = "__mapped";
            fieldIdLat = "latitude";
            fieldIdLong = "longitude";
            coreStationFieldId = "position";
          }
          var deploymentname = $(this).attr("name").split("_", 1)[0];
          if(deploymentname.length > 1) {
            deploymentname = deploymentname.substring(0, 1).toUpperCase() + deploymentname.substring(1, deploymentname.length).toLowerCase();
            if (deploymentname!='Statistics') {
              var exists = false;
              $.each(deployments, function(){
                if (this.name == deploymentname) {
                  exists = true;
                  return false;
                }
              });
              if (!exists)
                deployments.push(new deployment(deploymentname));
            }
          }
        }
      });
      
      // check if there is any deployment with the required virtual sensor
      if (deployments.length == 0) {
        $("#starttext").html("<p>Warning: No deployment available with the required virtual sensor gps_nav.</p>");
        $("#maindiv #mapdiv").hide();
        $("#maindiv #deployment_navigation").hide();
      }
      else {
        // display
        var visible = 0;
        $.each(deployments, function(i, l){
          if (this.name == $.cookie("deployment")) {
            visible = i;
            return false;
          }
        });
        
        $.each(deployments, function(i, depl) {
            // add tab
            $("#deployment_menu").append($.LI({}, $.A({
            "id":"deployment_menu_item_"+depl.name,
            "href":"javascript:showDeployment("+i+")"
            },depl.name)));
            
            $.each(getCoreStationIds(i), function(){
              addNewCoreStation(depl, this.id);
            });
          
            $("#deployment_"+depl.name).hide();
        });
        showDeployment(visible);
        
        $("#starttext").html("<p>Sensed data and current position of the sensors.</p>");
        
        var loc = window.location;
        g1Config = {
          "graph": {
              "div": "g1_div",
              "type": "dygraph",
              "width": 600,
              "height": 250,
              "showForm": false
          },
          "appUrl": "http://whymper.ethz.ch:24001/vizzly?",
          "imageUrl": "http://whymper.ethz.ch:24001/images/",
          "signals": {
              "y1": [
              {
                  "displayName": "Tram 1: Particulate matter [#]",
                  "gsnUrl": window.location.host,
                  "virtualSensor": deployments[visible].name.toLowerCase() + "_minidisc_gps",
                  "field": "number",
                  "deviceId": 2006,
                  "scaling": 1.0,
                  "visible": true,
                  "thresholds": [ 25000.0, 20000.0 ]
              },
              {
                    "displayName": "Tram 1: Ozone [ppb]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_oz47_instant_calibrated",
                    "field": "ozone_ppb",
                    "deviceId": 3,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 18.0, 8.0 ]
              },
              {
                    "displayName": "Tram 1: CO [ppm]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_alphasense_co_gps",
                    "field": "sensor_ppm",
                    "deviceId": 3,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 1.5, 1.0 ]
              },
              {
                    "displayName": "Tram 1: Temperature [Â°C]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_oz47_instant_calibrated",
                    "field": "temperature",
                    "deviceId": 3,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 6.0, 15.0 ]
              },
              {
                  "displayName": "Tram 2: Particulate matter [#]",
                  "gsnUrl": window.location.host,
                  "virtualSensor": deployments[visible].name.toLowerCase() + "_minidisc_emb__mapped",
                  "field": "number",
                  "deviceId": 4,
                  "scaling": 1.0,
                  "visible": true,
                  "thresholds": [ 25000.0, 20000.0 ]
              },
              {
                    "displayName": "Tram 2: Ozone [ppb]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_oz47_only_init_calibrated",
                    "field": "ozone_ppb",
                    "deviceId": 4,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 18.0, 8.0 ]
              },
              {
                    "displayName": "Tram 2: CO [ppm]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_alphasense_co_gps",
                    "field": "sensor_ppm",
                    "deviceId": 4,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 1.5, 1.0 ]
              },
              {
                  "displayName": "Tram 3: Particulate matter [#]",
                  "gsnUrl": window.location.host,
                  "virtualSensor": deployments[visible].name.toLowerCase() + "_minidisc_emb__mapped",
                  "field": "number",
                  "deviceId": 5,
                  "scaling": 1.0,
                  "visible": true,
                  "thresholds": [ 25000.0, 20000.0 ]
              },
              {
                    "displayName": "Tram 3: Ozone [ppb]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_oz47_only_init_calibrated",
                    "field": "ozone_ppb",
                    "deviceId": 5,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 18.0, 8.0 ]
              },
              {
                    "displayName": "Tram 3: CO [ppm]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_alphasense_co_gps",
                    "field": "sensor_ppm",
                    "deviceId": 5,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 1.5, 1.0 ]
              },
              {
                  "displayName": "Tram 4: Particulate matter [#]",
                  "gsnUrl": window.location.host,
                  "virtualSensor": deployments[visible].name.toLowerCase() + "_minidisc_emb__mapped",
                  "field": "number",
                  "deviceId": 6,
                  "scaling": 1.0,
                  "visible": true,
                  "thresholds": [ 25000.0, 20000.0 ]
              },
              {
                    "displayName": "Tram 4: Ozone [ppb]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_oz47_only_init_calibrated",
                    "field": "ozone_ppb",
                    "deviceId": 6,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 18.0, 8.0 ]
              },
              {
                    "displayName": "Tram 4: CO [ppm]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_alphasense_co_gps",
                    "field": "sensor_ppm",
                    "deviceId": 6,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 1.5, 1.0 ]
              },
              {
                  "displayName": "Tram 5: Particulate matter [#]",
                  "gsnUrl": window.location.host,
                  "virtualSensor": deployments[visible].name.toLowerCase() + "_minidisc_emb__mapped",
                  "field": "number",
                  "deviceId": 7,
                  "scaling": 1.0,
                  "visible": true,
                  "thresholds": [ 25000.0, 20000.0 ]
              },
              {
                    "displayName": "Tram 5: Ozone [ppb]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_oz47_only_init_calibrated",
                    "field": "ozone_ppb",
                    "deviceId": 7,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 18.0, 8.0 ]
              },
              {
                    "displayName": "Tram 5: CO [ppm]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_alphasense_co_gps",
                    "field": "sensor_ppm",
                    "deviceId": 7,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 1.5, 1.0 ]
              },
              {
                  "displayName": "Tram 6: Particulate matter [#]",
                  "gsnUrl": window.location.host,
                  "virtualSensor": deployments[visible].name.toLowerCase() + "_minidisc_emb__mapped",
                  "field": "number",
                  "deviceId": 8,
                  "scaling": 1.0,
                  "visible": true,
                  "thresholds": [ 25000.0, 20000.0 ]
              },
              {
                    "displayName": "Tram 6: Ozone [ppb]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_oz47_only_init_calibrated",
                    "field": "ozone_ppb",
                    "deviceId": 8,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 18.0, 8.0 ]
              },
              {
                    "displayName": "Tram 6: CO [ppm]",
                    "gsnUrl": window.location.host,
                    "virtualSensor": deployments[visible].name.toLowerCase() + "_alphasense_co_gps",
                    "field": "sensor_ppm",
                    "deviceId": 8,
                    "scaling": 1.0,
                    "visible": true,
                    "thresholds": [ 1.5, 1.0 ]
              },
              {
                  "displayName": "Smartphone: Ozone [ppb]",
                  "gsnUrl": window.location.host,
                  "virtualSensor": deployments[visible].name.toLowerCase() + "_gasmobile_ozone_uncalibrated",
                  "field": "ozone_ppb",
                  "deviceId": 300,
                  "scaling": 1.0,
                  "visible": true,
                  "thresholds": [ 17.0, 15.0 ]
              }
              ]
          }
        };
    
        aggMap = new AggregationMap(g1Config, document.getElementById("map_canvas"));
        
        fetchGPSPositions();
        
      }
    }
  });
});

function fetchGPSPositions() {

  var seldepl = selectedDeploymentNr;
  
  // get longitude and latitude for each core station of the selected deployment
  $.each(deployments[seldepl].coreStations, function(i, l){

    var id = this.id;
    var marker = this.marker;

    $.ajax({
      type: "GET",
      url: "/data?vsName=" + deployments[seldepl].name.toLowerCase() + "_gps_nav" + tableEnding + "&fields=" + coreStationFieldId + "&fields=" + fieldIdLong + "&fields=" + fieldIdLat + "&critfield=" + coreStationFieldId + "&neg=&critop==&critval=" + this.id + "&nb=1",
          async: false,
          cache: false,
          timeout: 30000,
      success: function(data){
        var lati;
        var longi;
        $("line", data).each(function(){
          if ($("field:eq(0)", this).text() != coreStationFieldId) {
            longi = $("field:eq(1)", this).text();
            lati = $("field:eq(2)", this).text();
            
            var absdlat = Math.abs( Math.round(Math.round(lati/100) * 1000000.));
            var absmlat = Math.abs( Math.round((lati - absdlat/10000) * 1000000.));
      
            var absdlon = Math.abs( Math.round(Math.round(longi/100) * 1000000.));
            var absmlon = Math.abs( Math.round((longi - absdlon/10000) * 1000000.));
      
            lati = Math.round(absdlat + (absmlat/60.) ) * 1/1000000;
            longi = Math.round(absdlon + (absmlon/60.) ) * 1/1000000;

            var myLatlng = new google.maps.LatLng(lati, longi);
            marker.setMap(aggMap.map);
            marker.setPosition(myLatlng);
            
            if (id == 3) {
              marker.setTitle("Tram: 1 (3005), Depot: Oerlikon,  Dev. ID: 3");
            }
            else if (id == 4) {
              marker.setTitle("Tram: 2 (3005), Depot: Oerlikon,  Dev. ID: 4");
            }
            else if (id == 5) {
              marker.setTitle("Tram: 3 (3009), Depot: Kalkbreite,  Dev. ID: 5");
            }
            else if (id == 6) {
              marker.setTitle("Tram: 4 (3033), Depot: Kalkbreite,  Dev. ID: 6");
            }
            else if (id == 7) {
              marker.setTitle("Tram: 5 (3040), Depot: Kalkbreite,  Dev. ID: 7");
            }
            else if (id == 8) {
              marker.setTitle("Tram: 6 (3053), Depot: Irchel,  Dev. ID: 8");
            }
            else {
              marker.setTitle("Device: "+id);
            }
          }
        })
      }
    });
  });
  
  topologyUpdateTimer = setTimeout("fetchGPSPositions()",30000);
  
};

//]]>-->
</script>
</head>
<body>  

<div id="container">
	<div id="header">
		<h1><a href="." id="gsn-name" style="display:none">GSN</a></h1>
	</div>
	<div id="navigation">
	</div>
	
	<div id="separator">
		<div id="starttext"> </div>
	</div>

	<div id="maindiv">
		<div id="deployment_navigation">
		<ul id="deployment_menu">
		<li />
		</ul>
		</div>
		
		<p></p>
		<div id="map_canvas" style="width:100%; height:500px"></div>
		
	</div>
	
	<div class="separator">
		<div id="footer">
		      <table width="100%">
				<tr>
					<td style="width:50%;color:#444444;"><b>A Project of <a href="http://www.ethz.ch" target="_blank">ETH Zurich</a>, <a href="http://www.unibas.ch" target="_blank">Uni Basel</a> and <a href="http://www.uzh.ch" target="_blank">Uni Zurich</a></b></td>
					<td style="text-align:right;width:50%;font-size:9px;">Powered by <a href="http://gsn.sourceforge.net/">GSN</a>,  Distributed Information Systems Lab, EPFL 2006</td>
				</tr>
			</table>
		</div>
	</div>
</div>
<!-- script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5632004-2");
pageTracker._initData();
pageTracker._trackPageview();
</script -->
</body>
</html>
