<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <title>GSN</title>
        
        <link rel="stylesheet" href="style/gsn.css" type="text/css" media="screen,projection" />
        <script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
        <script type="text/javascript" src="js/jquery-dom.js"></script>
        <script type="text/javascript" src="js/jquery.history.js"></script>
        <script type="text/javascript" src="js/jquery.cookie.js"></script>
        <script type="text/javascript" src="js/uptime.js"></script>

        <!-- Visualization -->
        <link rel="stylesheet" type="text/css" href="http://tik41x:23001/sensorviz.css" />
        <link rel="stylesheet" type="text/css" href="style/jquery-ui-1.8.13.custom.css" />
        <!--[if IE]><script src="http://tik41x:23001/excanvas.js"></script><![endif]-->
        <script type='text/javascript' src='js/jquery-ui-1.8.13.min.js'></script>
        <script type='text/javascript' src='http://tik41x:23001/dygraph-combined.js'></script>
        <script type='text/javascript' src='js/viz/sensorviz.js'></script>

<script type="text/javascript">
<!--//<![CDATA[

var deployments = new Array();

function getDeployment(name) {
  var d=-1;
  for (i=0;i<deployments.length;i++)
    if (deployments[i].name==name) {
      d=deployments[i];
      break;
    }
  return d;
}

$(document).ready(function() {
    $.get('/menu.jsp', {selected: "science"}, function(data) {
      $('#navigation').html(data);
    }, 'html');
    $("#navigation ul a.local").bind("click",function() { return GSN.nav($(this).text()); });

    // deployments
    // load deployments
    $.ajax({
      type: "GET",
      url: "/gsn?structure",
      success: function(data){
        if ($(document).attr("title")=="GSN") {
          var gsn = $("gsn",data);
          $(document).attr("title",$(gsn).attr("name"));
          $("#gsn-name").empty().append($(gsn).attr("name"));
          $("#gsn-desc").empty().append($(gsn).attr("description"));
          $("#gsn-author").empty().append($(gsn).attr("author")+" ("+$(gsn).attr("email")+")");
          var gsnname = $(gsn).attr("name").replace(/.*::\s*GSN\s*-\s*/, "").replace(/\s/g,"").toLowerCase();
          $('head', document).append('<link rel="shortcut icon" href="/img/favicon/permasense-'+gsnname+'.ico"><link rel="icon" href="/img/favicon/permasense-'+gsnname+'.ico">');
        }
        $("#gsn-name").show();
        uptime.setTime($(gsn).attr("uptime"));
        var visible=-1;
        if (getDeployment($.cookie("deployment"))>-1)
          visible = $.cookie("deployment");
        $("virtual-sensor",data).each(function(){
          var deploymentname = $(this).attr("name").split("_", 1)[0];
          if(deploymentname.length > 1 && deploymentname!='statistics') {
            deploymentname = deploymentname.substring(0, 1).toUpperCase() + deploymentname.substring(1, deploymentname.length).toLowerCase();
            if (getDeployment(deploymentname)<0) {
              deployments.push(new Object({"name":deploymentname, "graphconfig":[]}));
              // add deployment tabs and container
              $('#deployment_menu').append('<li><a href="javascript:showPlots(\''+deploymentname+'\')" id="deployment_menu_item_'+deploymentname+'">'+deploymentname+'</a></li>');
              $('#plotscontainer').append('<div id="plot_'+deploymentname+'">'+deploymentname+'</div>');
              $('#plot_'+deploymentname).hide();
              if (deployments.length==1 & visible==-1) {
                visible = deploymentname;
              }
            }
            var thisdeployment = getDeployment(deploymentname);
            // find out about available node ids/positions
            if($(this).attr("name").match(/.*_topology__public$/)) {
              var topology_vs = $(this).attr("name");
              var fields = ["sysvoltage", "sdivoltage", "temperature", "humidity"];
              // fetch node ids (second ajax call)
              $.ajax({
                type: "GET",
                url: "/field?vs="+topology_vs+"&field=DATA&pk=latest",
                dataType: "xml",
              // ajax SUCCESS ***********************************
                success: function(data){
                /* test visualization  ---v */
                var positions = new Array();
                $("sensornode[position]",data).each(function() {
                  positions.push($(this).attr("position").valueOf());
                });
                positions.sort(function(a,b){return a - b});
                // for each field, plot data
                $(fields).each(function() {
                  var field = this;
                  var config = {
                    "graph": {
                      "div": "g_"+this.valueOf(),
                      "type": "dygraph",
                      "width": 800,
                      "height": 350,
                      "showForm": true
                    },
                    "appUrl": "http://tik41x:23001/sensorviz?",
                    "signals": {
                      "y1": []
                    },
                  };
                  // add nodes to plot
                  $(positions).each(function() {
                    var signal = {
                      "displayName":"Position "+this,
                      "gsnUrl": "tik51x:22001",
                      "virtualSensor": "etz_dozer_nodehealth__conv",
                      "position": this,
                      "field": field,
                      "scaling": 1.0,
                      "visible": true
                    };
                    config.signals.y1.push(signal);
                  });
                  thisdeployment.graphconfig.push({"config":config, "field":field, "title":field});
                });
                if (visible==deploymentname)
                  showPlots(deploymentname);
                /*
                  $("#plotscontainer").append("<div id=\"g_"+field+"\"/>");
                  var g = new FrontendCreator(config);
                */
                },
              // ajax ERROR ***********************************
                error : function(XMLHttpRequest, textStatus, errorThrown) {
                  // TODO
                },
                complete: function(jqXHR, textStatus) {
                }
              });
            }
          }
        }); // end VS loop
      }
    }); // end of first ajax call
});

function showPlots(id) {
  $(deployments).each(function() {
      $("#plot_"+this.name).empty().hide();
      $("#deployment_menu_item_"+this.name).removeClass("selected");
  });
  $("#plot_"+id).show();
  $("#deployment_menu_item_"+id).addClass("selected");
  // add graphs
  $(getDeployment(id).graphconfig).each(function() {
    $("#plot_"+id).append('<div id="g_'+this.field+'"/>');
    var g = new FrontendCreator(this.config);
  });
  $.cookie("deployment" , id);
}	
//]]>-->
</script>
</head>
<body>

<div id="container">
	<div id="header">
		<h1><a href="." id="gsn-name" style="display:none">GSN</a></h1>
	</div>
	<div id="navigation">
	</div>

	<div id="maindiv">
		<div id="deployment_navigation">
		<ul id="deployment_menu">
		<li />
		</ul>
		</div>	
		
		<div id="plotscontainer" style="margin-top:5px"></div>
		
	</div>
	<div class="separator">
		<div id="footer">
		      <table width="100%">
				<tr>
					<td style="width:50%;color:#444444;"><b>A Project of <a href="http://www.ethz.ch" target="_blank">ETH Zurich</a>, <a href="http://www.unibas.ch" target="_blank">Uni Basel</a> and <a href="http://www.uzh.ch" target="_blank">Uni Zurich</a></b></td>
					<td style="text-align:right;width:50%;font-size:9px;">Powered by <a href="http://gsn.sourceforge.net/">GSN</a>,  Distributed Information Systems Lab, EPFL 2006</td>
				</tr>
			</table>
		</div>
	</div>
</div>
<!-- script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-5632004-2");
pageTracker._initData();
pageTracker._trackPageview();
</script -->
</body>
</html>
