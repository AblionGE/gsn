\graphicspath{{chapters/ch-virtualsensors/figures/}}
\chapter{Virtual Sensors}
\section{Introduction}
Virtual Sensor is the main abstraction used by GSN to represent a well structured data stream.
By well structured we mean, the structure of the stream is known in advanced and it is not going to be changed
while GSN is running.
\section{Graphical Representation}
\section{}

\section{Notes}
\subsection{What if the structure of the virtual sensor changes?}
We are not changing the structure of the database automatically (adding or droping fields). If your virtual sensors structure
changes and if you are using \emph{permannet storages} such as MySQL or File-based HSQLDB, you have to change the structure of the
table manually. 
\subsection{Where is the DTD for the virtual sensor?}
We are using JiBX Java-XML binding project. The structure of the virtual sensor descriptor file is defined in \texttt{conf/VirtualSensorDescription.xml}.
\subsection{Which databases we support ?}
At the moment we are supporting HSqlDB and MySQL. Checkout the mailing list for the latest issues regarding the other databases and their
support status.
\subsection{Which projects are using GSN ?}
There are over 10 EU/Swiss funding research projects using GSN as their core technology.
\section{GSN.XML file}
\section{SafeStorage}
\subsection{Why we need it? }
\subsection{How to use it }
\subsection{How to write a wrapper for the safe storage}
\section{Wrappers}
\section{Their mandatory parameters}
\section{How it works}
\section{Introduction}
\section{GeoRSS}
\section{SQL Syntax}
\section{Introduction}
\section{Introduction}
\section{Introduction}
\section{Introduction}
\section{Introduction}
\section{Introduction}
\section{Introduction}
\section{Network communication}
Looking inside the GSN infrastructure, there are at least half a dozen difference network communication channels are used. In this section I would like to dive in to the details
of the some major communication protocols designed and implemented in GSN. 

\subsection{Reusing Data Streams}

One of the main ideas behind the virtual sensors is resuability. The resuability comes in two forms.
First being able to recreate the same processing logic on different data streams.
Second being able to reuse streaming data produced by other parties over the internet and possibly create a new data stream but instrumenting the original streams.
In this section, I present the both high level and low level details associated with the second aspect of the reusability.

The virtual sensor descriptor file is the first place which specifies the intention of reusing streaming data from another virtual sensor. The source virtual sensor can be located
anywhere as long as it is accessible through the network, this ofcourse includes the local machine and any other machine on the Internet. 


In GSN, our vision is having an internet scale streaming world in which people can publish streaming data which
can be produced directly using some sort of a measurement device which can range from a physical wireless sensor to stock ticks from a financial market.

\section{GSN Notifications}

\subsection{Introduction}

In GSN, virtual sensors can be configured to notify users of certain events, e.g. to send an Email notification to an user informing them that a particular event has occurred. To implement notifications in GSN is very straight forward. The basic principle is that once the virtual sensor query is answered as specified in the virtual sensor description file, e.g.

\begin{xmlcode}
<query>SELECT temperature FROM s1 WHERE temperature >= 100</query>
\end{xmlcode}

a notification can be triggered  by the java processing class

\begin{xmlcode}
<class-name>gsn.vsensor.EmailVirtualSensor</class-name>
\end{xmlcode}

see examples in next section. Thus, any type of notifications, e.g. Email, SMS, SIP, Fax, MMS can be implemented easily in a virtual sensor processing class. 

The technical details of implementing notifications are left to the designer. Below are three examples of some of the notification services already implemented in GSN.

\subsection{Email Notification Virtual Sensor}

This virtual sensor implements an Email notification. The parameter for the virtual sensor are displayed on the \tableref{table:parameters_email_vs}

\begin{table*}[!htp]
	\centering
	{\normalfont\footnotesize
	\begin{tabulary}{\textwidth}{|C|C|C|C|J|}%
	\hline
		\textbf{Parameter Name} &
		\textbf{Type} &
		\textbf{Mandatory} &
		\textbf{Default} &
		\textbf{Description} \\
	\hline
	\hline
		RECEIVER &
		String &	
		Yes &
		None &
		Name of the email recipient \\
	\hline
		receiver-email &
		String &	
		Yes &
		None &	
		Email address of the recipient \\
	\hline
		sender-email &
		String &	
		Yes &
		None &	
		Email address of the sender \\
	\hline
		mail-server &
		String &	
		Yes &
		None &	
		URL for the email (SMTP) server \\
	\hline
		subject &
		String &	
		Yes &
		None &	
		Subject of the email \\
	\hline
		message &
		String &	
		Yes &
		None &	
		Email message \\
	\hline
	\end{tabulary}
	}
	\caption{Parameters for Email VS}
	\label{table:parameters_email_vs}
\end{table*}

An example of how to use this virtual sensor is shown on the \listingref{listing:xml:emailnotification_vsd}.

\begin{xmlcode}[caption={Sample of Email Notification VSD file}, label=listing:xml:emailnotification_vsd]
<virtual-sensor name="email" priority="10">
	<processing-class>
		<class-name>gsn.vsensor.EmailVirtualSensor</class-name>
		<init-params>
			<param name="RECEIVER">John Connor</param>
			<param name="receiver-email">john.connor@gmail.com</param>
			<param name="sender-email">admin@sensorinternet.com</param>
			<param name="mail-server">smtp.gmail.com</param>
			<param name="subject">Abnormal Temperature Detected</param>
			<param name="MESSAGE">Sensor 114 has a value of 100 C.</param>   
		</init-params>
		<output-structure>
			<field name="temp" type="double" />
		</output-structure>
	</processing-class>
	<description>Send an Email Notification</description>
	<life-cycle pool-size="10" />
	<addressing />
	<storage history-size="10m" />
	<streams>
		<stream name="in1">
			<source alias="s1" sampling-rate="1" storage-size="1">
				<address wrapper="multiformat">
					<predicate key="HOST">localhost</predicate>
					<predicate key="PORT">22001</predicate>
				</address>
				<query>SELECT * FROM wrapper</query>
			</source>
			<query>SELECT temperature FROM s1 WHERE temperature >= 100</query>
		</stream>
	</streams>
</virtual-sensor>
\end{xmlcode}


\subsection{SMS Notification Virtual Sensor}

This virtual sensor implements SMS (Short Message Service) notification. This virtual sensor is very similar to the email virtual sensor â€“ an email is sent to a Mobile phone operator or SMS gateway provider based on the user's mobile account and the email is converted and send as a SMS to the given phone number. The parameter for the virtual sensor are described on the \tableref{table:parameters_sms_vs}.


\begin{table*}[!htp]
	\centering
	{\normalfont\footnotesize
	\begin{tabulary}{\textwidth}{|C|C|C|C|J|}%
	\hline
		\textbf{Parameter Name} &
		\textbf{Type} &
		\textbf{Mandatory} &
		\textbf{Default} &
		\textbf{Description} \\
	\hline
	\hline
		phone-number &
		String &	
		Yes &
		None &
		The mobile phone number to send the message \\
	\hline
		password &
		String &
		Yes &
		None &
		The password to login to the mobile operator or SMS gateway provider \\
	\hline
		sms-server &
		String &
		Yes &
		None &
		URL address of the mobile phone operator or SMS gatewat provider \\
	\hline
		message-format &
		String &
		Yes &
		None &
		The format of the SMS message in StringTemplate-syntax, e.g. Temperature: \$TEMP\$ where TEMP has some value given from the GSN StreamElement \\
	\hline
	\end{tabulary}
	}
	\caption{Parameters for SMS VS}
	\label{table:parameters_sms_vs}
\end{table*}

An example of how to use this virtual sensor is shown on the \listingref{listing:xml:smsnotification_vsd}.

\begin{xmlcode}[caption={Sample of SMS Notification VSD file}, label=listing:xml:smsnotification_vsd]
<virtual-sensor name="sms" priority="10">
	<processing-class>
		<class-name>gsn.vsensor.SMSVirtualSensor</class-name>
		<init-params>
			<param name="phone-number">004413243545</param>
			<param name="password">3524</param>
			<param name="sms-server">vodafone.co.uk</param>
			<param name="message-format">Temperature: $TEMP$</param>
		</init-params>
		<output-structure>
			<field name="temp" type="double" />
		</output-structure>
	</processing-class>
	<description>Send a SMS Notification</description>
	<life-cycle pool-size="10" />
	<addressing />
	<storage history-size="10m" />
	<streams>
		<stream name="in1">
			<source alias="s1" sampling-rate="1" storage-size="1">
				<address wrapper="multiformat">
					<predicate key="HOST">localhost</predicate>
					<predicate key="PORT">22001</predicate>
				</address>
				<query>SELECT * FROM wrapper</query>
			</source>
			<query>SELECT temperature FROM s1 WHERE temperature >= 100</query>
		</stream>
	</streams>
</virtual-sensor>
\end{xmlcode}

Note that this virtual sensor will only work if you have an account with a mobile phone operator or an internet SMS gateway provider. 





